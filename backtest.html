<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ORB Backtest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailframes.com/releases/latest/tailframes.min.js" defer></script>
  <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
  
  <style>
    .num-pos { color: #065f46; }
    .num-neg { color: #9f1239; }
    .sticky-th { position: sticky; top: 0; background: white; z-index: 1; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Site navigation -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2 font-semibold text-slate-800">
        <svg class="h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" aria-hidden="true"><path d="M192 384L88.5 384C63.6 384 48.3 356.9 61.1 335.5L114 247.3C122.7 232.8 138.3 224 155.2 224L250.2 224C326.3 95.1 439.8 88.6 515.7 99.7C528.5 101.6 538.5 111.6 540.3 124.3C551.4 200.2 544.9 313.7 416 389.8L416 484.8C416 501.7 407.2 517.3 392.7 526L304.5 578.9C283.2 591.7 256 576.3 256 551.5L256 448C256 412.7 227.3 384 192 384L191.9 384zM464 224C464 197.5 442.5 176 416 176C389.5 176 368 197.5 368 224C368 250.5 389.5 272 416 272C442.5 272 464 250.5 464 224z"/></svg>
        <span>ORB</span>
      </div>
      <div class="flex items-center gap-2">
        <a data-nav href="index.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Performance</a>
        <a data-nav href="backtest.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Backtest</a>
      </div>
    </div>
  </nav>
  <script>
    // Activate nav item for current page
    (function(){
      try {
        const file = (location.pathname.split('/').pop() || 'backtest.html').toLowerCase();
        document.querySelectorAll('a[data-nav]').forEach(a => {
          const href = (a.getAttribute('href') || '').toLowerCase();
          const active = href === file || (file === '' && href.endsWith('index.html'));
          a.classList.toggle('bg-slate-800', active);
          a.classList.toggle('text-white', active);
          a.classList.toggle('hover:bg-slate-100', !active);
          if (active) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
        });
      } catch {}
    })();
  </script>

  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 id="mainTitle" class="text-2xl md:text-3xl font-semibold">ORB Backtest</h1>
      <p class="text-slate-600 mt-1">This page will host backtest tooling. We will develop this further later on.</p>
    </header>

    <!-- Symbol segmented control (like index.html) -->
    <section id="symbolPicker" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 mb-6">
      <div class="flex items-center gap-2">
        <span class="text-sm text-slate-600">Symbol:</span>
        <div class="flex-1 min-w-0 overflow-x-auto">
          <div id="tickerSegment" class="inline-flex min-w-max rounded-xl border border-slate-200 overflow-hidden whitespace-nowrap">
            <span class="px-3 py-1.5 text-sm text-slate-500">Loading…</span>
          </div>
        </div>
      </div>
      <!-- Parameters -->
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <label class="block">
          <span class="text-sm text-slate-600">orb_m</span>
          <input id="inp_orb_m" type="number" min="1" max="120" step="1" value="25" class="mt-1 w-full appearance-none bg-white text-slate-800 ring-1 ring-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 shadow-sm rounded-xl px-3 py-2 text-sm" />
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">target_R</span>
          <input id="inp_target_R" type="number" min="0" max="100" step="0.1" value="2" class="mt-1 w-full appearance-none bg-white text-slate-800 ring-1 ring-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 shadow-sm rounded-xl px-3 py-2 text-sm" />
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">stop_R</span>
          <input id="inp_stop_R" type="number" min="0" max="100" step="0.1" value="2" class="mt-1 w-full appearance-none bg-white text-slate-800 ring-1 ring-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500/60 shadow-sm rounded-xl px-3 py-2 text-sm" />
        </label>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow-soft p-4 md:p-6">
      <p class="text-slate-600 text-sm">Placeholder content. Navigation at the top lets you switch between Performance and Backtest.</p>
    </section>
  </div>
  <script>
    // Backtest page: symbol picker using data/index.json
    let currentTicker = '';
    function setTicker(sym){
      currentTicker = (sym||'').toUpperCase();
      const titleEl = document.getElementById('mainTitle');
      if (titleEl) {
        const prefix = currentTicker ? currentTicker + ' - ' : '';
        const full = prefix + 'ORB Backtest';
        titleEl.textContent = full;
        document.title = full;
      }
    }

    async function populateTickerSegment(){
      const container = document.getElementById('tickerSegment');
      if (!container) return;
      container.innerHTML = '<span class="px-3 py-1.5 text-sm text-slate-500">Loading…</span>';
      const render = (symbols)=>{
        container.innerHTML = '';
        symbols.forEach((s,i)=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          const cls = 'px-3 py-1.5 text-sm font-medium bg-white hover:bg-slate-100' + (i < symbols.length - 1 ? ' border-r border-slate-200' : '');
          btn.className = cls;
          btn.setAttribute('data-symbol', s);
          btn.textContent = s;
          container.appendChild(btn);
        });
      };

      // Primary: index.json (array of symbols)
      try {
        const res = await fetch('data/index.json', { cache: 'no-cache' });
        if (res.ok) {
          const list = await res.json();
          if (Array.isArray(list) && list.length) {
            const syms = list.map(s => String(s).toUpperCase());
            render(syms);
            return;
          }
        }
      } catch {}

      // Fallback: probe directory listing for *_1m.csv
      try {
        const res = await fetch('data/', { cache: 'no-cache' });
        if (res.ok) {
          const text = await res.text();
          const ct = (res.headers.get('content-type')||'').toLowerCase();
          let files = [];
          if (ct.includes('text/html')) {
            const doc = new DOMParser().parseFromString(text, 'text/html');
            files = Array.from(doc.querySelectorAll('a')).map(a => a.getAttribute('href')).filter(Boolean);
          } else {
            files = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          }
          const regex = /^([A-Za-z0-9-]+)_1m\.csv$/i;
          const syms = [];
          for (const f of files) {
            const name = (f||'').split('/').pop();
            const m = name.match(regex);
            if (m) syms.push(m[1].toUpperCase());
          }
          const uniq = Array.from(new Set(syms));
          if (uniq.length) { render(uniq); return; }
        }
      } catch {}

      // Default
      render(['TQQQ','TSLA','PLTR','UVXY']);
    }

    // Click handler: set active button + update title
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('#tickerSegment button[data-symbol]');
      if (!btn) return;
      const seg = document.getElementById('tickerSegment');
      if (!seg) return;
      seg.querySelectorAll('button').forEach(b => {
        b.classList.remove('bg-slate-800','text-white','focus:outline-none');
        if (!b.classList.contains('bg-white')) b.classList.add('bg-white');
        if (!b.classList.contains('hover:bg-slate-100')) b.classList.add('hover:bg-slate-100');
      });
      btn.classList.add('bg-slate-800','text-white','focus:outline-none');
      btn.classList.remove('bg-white','hover:bg-slate-100');
      setTicker(btn.getAttribute('data-symbol'));
    });

    // init
    populateTickerSegment().catch(()=>{});

    // Inputs: basic clamping and a getter for future use
    (function(){
      const orb = document.getElementById('inp_orb_m');
      const trg = document.getElementById('inp_target_R');
      const stp = document.getElementById('inp_stop_R');
      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      if (orb) orb.addEventListener('change', ()=> { const v = parseInt(orb.value,10); orb.value = String(clamp(Number.isFinite(v)?v:25, 1, 120)); });
      if (trg) trg.addEventListener('change', ()=> { const v = parseFloat(trg.value); trg.value = String(clamp(Number.isFinite(v)?v:2, 0, 100)); });
      if (stp) stp.addEventListener('change', ()=> { const v = parseFloat(stp.value); stp.value = String(clamp(Number.isFinite(v)?v:2, 0, 100)); });
      window.getBacktestParams = function(){
        return {
          symbol: currentTicker,
          orb_m: orb ? parseInt(orb.value,10) : 25,
          target_R: trg ? parseFloat(trg.value) : 2,
          stop_R: stp ? parseFloat(stp.value) : 2,
        };
      };
    })();
  </script>
</body>
</html>
