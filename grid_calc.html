
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grid Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"
  />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <!-- Apache ECharts for interactive charts (mobile pinch-zoom supported) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .num-pos { color: #119d6e !important; }
    .num-neg { color: #ff0000 !important; }
    .pnl-strong { font-size: 1.8rem !important; }
    .sticky-th { position: sticky; top: 0; background: white; z-index: 1; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    thead th { position: sticky; top: 0; background: white; z-index: 1; }

    /* Hide native spin buttons for key numeric inputs */
    #inp_orb_m::-webkit-outer-spin-button,
    #inp_orb_m::-webkit-inner-spin-button,
    #inp_target_R::-webkit-outer-spin-button,
    #inp_target_R::-webkit-inner-spin-button,
    #inp_stop_R::-webkit-outer-spin-button,
    #inp_stop_R::-webkit-inner-spin-button,
    #inp_risk_pct::-webkit-outer-spin-button,
    #inp_risk_pct::-webkit-inner-spin-button,
    #inp_aum0::-webkit-outer-spin-button,
    #inp_aum0::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #inp_orb_m,
    #inp_target_R,
    #inp_stop_R,
    #inp_risk_pct,
    #inp_aum0 {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Generic: hide spinners for any future number input */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Session controls responsive layout */
    #sessionSegment {
      display: flex;
      flex-wrap: wrap;
      max-width: 100%;
      min-width: 0;
      white-space: normal;
    }
    #sessionSegment button {
      flex: 0 0 auto;
    }

    .details-icon summary::-webkit-details-marker {
      display: none;
    }
    .details-icon summary::marker {
      content: '';
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Site navigation -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-6 py-3 flex items-center gap-4">
      <div class="flex items-center gap-6 flex-1 min-w-0">
        <div class="flex items-center gap-2 font-semibold text-slate-800">
          <svg class="h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" aria-hidden="true"><path d="M192 384L88.5 384C63.6 384 48.3 356.9 61.1 335.5L114 247.3C122.7 232.8 138.3 224 155.2 224L250.2 224C326.3 95.1 439.8 88.6 515.7 99.7C528.5 101.6 538.5 111.6 540.3 124.3C551.4 200.2 544.9 313.7 416 389.8L416 484.8C416 501.7 407.2 517.3 392.7 526L304.5 578.9C283.2 591.7 256 576.3 256 551.5L256 448C256 412.7 227.3 384 192 384L191.9 384zM464 224C464 197.5 442.5 176 416 176C389.5 176 368 197.5 368 224C368 250.5 389.5 272 416 272C442.5 272 464 250.5 464 224z"/></svg>
          <span>GRID</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <a data-nav href="grid.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Grid Backtest</a>
          <a data-nav href="grid_calc.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Grid Calculator</a>
          <a data-nav href="grid_about.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">About</a>
        </div>
      </div>
    </div>
  </nav>
  <script>
    // Activate nav item for current page
    (function(){
      try {
        const file = (location.pathname.split('/').pop() || 'grid.html').toLowerCase();
        document.querySelectorAll('a[data-nav]').forEach(a => {
          const href = (a.getAttribute('href') || '').toLowerCase();
          const active = href === file || (file === '' && href.endsWith('index.html'));
          a.classList.toggle('bg-slate-800', active);
          a.classList.toggle('text-white', active);
          a.classList.toggle('hover:bg-slate-100', !active);
          if (active) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
        });
      } catch {}
    })();
  </script>

  <div class="max-w-screen-2xl mx-auto p-6 space-y-6">
    <header class="mb-2">
      <h1 id="mainTitle" class="text-2xl md:text-3xl font-semibold">Grid Calculator</h1>
    </header>

    <section id="gridTabsNav" class="bg-white rounded-2xl shadow-soft p-3 md:p-4">
      <div class="overflow-x-auto -mx-3 md:mx-0 px-3 md:px-0">
        <nav class="flex min-w-max border-b border-slate-200 gap-1" role="tablist" aria-label="Grid utilities">
          <button
            type="button"
            id="tab-btn-grid-calculator"
            data-tab-button="grid-calculator"
            aria-controls="grid-calculator-tab"
            role="tab"
            aria-selected="true"
            class="inline-flex items-center gap-2 border-b-2 border-emerald-500 px-3 py-2 text-sm font-medium text-slate-900 transition"
          >
            <span class="inline-flex h-8 w-8 items-center justify-center text-emerald-500">
              <ion-icon name="grid-outline" class="text-2xl"></ion-icon>
            </span>
            <span>Grid Calculator</span>
          </button>
          <button
            type="button"
            id="tab-btn-breakeven-matrix"
            data-tab-button="breakeven-matrix"
            aria-controls="breakeven-matrix-tab"
            role="tab"
            aria-selected="false"
            class="inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition"
          >
            <span class="inline-flex h-8 w-8 items-center justify-center text-emerald-500">
              <ion-icon name="stats-chart-outline" class="text-2xl"></ion-icon>
            </span>
            <span>Breakeven Matrix</span>
          </button>
        </nav>
      </div>
    </section>

    <div
      id="grid-calculator-tab"
      data-tab-panel="grid-calculator"
      role="tabpanel"
      aria-labelledby="tab-btn-grid-calculator"
      class="space-y-6"
      tabindex="0"
    >
    <section id="gridParameters" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
      <div class="flex flex-col gap-1">
        <h2 class="font-semibold text-slate-700">Grid Parameters</h2>
        <p class="text-sm text-slate-500">Adjust the inputs below to preview ladder levels around the starting price.</p>
      </div>
      <div class="grid grid-flow-col auto-cols-[minmax(180px,1fr)] gap-4 overflow-x-auto pb-2">
        <label class="block">
          <span class="text-sm text-slate-600">Start Price ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpStartPrice"
              type="number"
              step="0.01"
              min="0"
              value="100"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase start price" data-num-target="inpStartPrice" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease start price" data-num-target="inpStartPrice" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Tick Size</span>
          <div class="relative mt-1">
            <select
              id="selTickSize"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="1">1</option>
              <option value="0.1">0.1</option>
              <option value="0.01" selected>0.01</option>
              <option value="0.005">0.005</option>
              <option value="0.001">0.001</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Grid Spacing</span>
          <div class="relative mt-1">
            <select
              id="selGridSpacing"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="fixed">Fixed Price</option>
              <option value="percent" selected>Percentage</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span id="gridSizeLabel" class="text-sm text-slate-600">Grid Size ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpGridSize"
              type="number"
              step="0.5"
              min="0.5"
              value="5"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase grid size" data-num-target="inpGridSize" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease grid size" data-num-target="inpGridSize" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Levels Down</span>
          <div class="mt-1 relative">
            <input
              id="inpLevelCount"
              type="number"
              min="1"
              max="100"
              step="1"
              value="20"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase levels down" data-num-target="inpLevelCount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease levels down" data-num-target="inpLevelCount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Levels Up</span>
          <div class="mt-1 relative">
            <input
              id="inpLevelCountUp"
              type="number"
              min="0"
              max="100"
              step="1"
              value="10"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase levels up" data-num-target="inpLevelCountUp" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease levels up" data-num-target="inpLevelCountUp" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Trade Amount ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpTradeAmount"
              type="number"
              min="0"
              step="50"
              value="1000"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase trade amount" data-num-target="inpTradeAmount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease trade amount" data-num-target="inpTradeAmount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
      </div>
    </section>

    <section id="gridCarousel" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3" aria-roledescription="carousel" aria-label="Grid chart views">
      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
        <div data-carousel-track class="flex w-full transition-transform duration-300 ease-out">
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridOverviewChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart compares the return of a hypothetical lump-sum buy-and-hold investment with the realised profit and loss of a grid strategy at each grid level. While buy-and-hold fully captures the asset's price movement-both gains and drawdowns-the grid progressively deploys and releases capital, resulting in a materially compressed payoff profile. The grid reduces downside drawdowns at the cost of limiting upside participation, trading raw exposure for improved capital survivability.
                </div>
              </details>
            </div>
          </div>
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridPlChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart shows the realised profit and loss of the grid strategy at each level, assuming no oscillation beyond the displayed range. Profits accumulate gradually on the way up through harvested trades, while losses increase more slowly on the way down compared to buy-and-hold. The curve illustrates how grid strategies rely on price oscillation rather than directional forecasting.
                </div>
              </details>
            </div>
          </div>
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridCashflowChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart shows cumulative net cashflow as price moves through grid levels. Downside levels reflect incremental capital committed through grid buys, while upside levels reflect cash returned through grid sells. Net cashflow captures trading activity rather than risk exposure and illustrates how the grid gradually converts price movement into realised cash over time.
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-center gap-2">
        <button type="button" data-carousel-dot="0" class="h-2.5 w-2.5 rounded-full bg-emerald-500" aria-label="Show view 1" aria-current="true"></button>
        <button type="button" data-carousel-dot="1" class="h-2.5 w-2.5 rounded-full bg-slate-300" aria-label="Show view 2"></button>
        <button type="button" data-carousel-dot="2" class="h-2.5 w-2.5 rounded-full bg-slate-300" aria-label="Show view 3"></button>
      </div>
    </section>

    <section id="gridLadderSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex flex-col gap-1">
        <h2 class="font-semibold text-slate-700">Grid Ladder Preview</h2>
        <p id="gridLadderSummary" class="text-sm text-slate-500">Adjust the grid parameters to preview ladder levels around the starting price.</p>
      </div>
      <div class="overflow-x-auto">
        <div id="gridLadderContainer" class="min-w-full rounded-xl border border-slate-200 bg-white">
          <div class="p-4 text-sm text-slate-500">Enter a valid starting price, grid size, and levels down to draw the ladder.</div>
        </div>
      </div>
    </section>

      <section id="gridJsonSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h2 class="font-semibold text-slate-700">Grid JSON Export</h2>
          <p class="text-sm text-slate-500">Copy the current ladder as JSON for scripting or sharing.</p>
        </div>
      </div>
      <div class="relative">
        <button
          type="button"
          id="btnCopyGridJson"
          class="absolute right-3 top-3 inline-flex items-center gap-2 rounded-lg border border-slate-600/30 bg-slate-800/80 px-3 py-1 text-xs font-medium text-white transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:bg-slate-700/50"
          disabled
        >
          <ion-icon name="copy-outline" class="text-base"></ion-icon>
          <span data-copy-label>Copy JSON</span>
        </button>
        <pre class="bg-slate-900 text-slate-100 rounded-2xl p-4 text-xs md:text-sm font-mono overflow-x-auto shadow-inner min-h-[140px]">
<code id="gridJsonCode">// Adjust grid inputs above to generate JSON.</code>
        </pre>
      </div>
      </section>
    </div>

    <div
      id="breakeven-matrix-tab"
      data-tab-panel="breakeven-matrix"
      role="tabpanel"
      aria-labelledby="tab-btn-breakeven-matrix"
      class="space-y-6 hidden"
      hidden
      tabindex="0"
    >
      <section class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
        <div class="flex flex-col gap-1">
          <h2 class="font-semibold text-slate-700">Breakeven Matrix</h2>
          <p class="text-sm text-slate-500">Explore how many take-profit fills are required to offset layered buys at each grid depth.</p>
        </div>
        <form id="breakevenMatrixForm" class="space-y-4">
          <div class="grid gap-4 md:grid-cols-3">
            <label class="block">
              <span class="text-sm text-slate-600">Max Levels</span>
              <input
                id="inpBreakevenLevels"
                type="number"
                min="10"
                max="200"
                value="50"
                data-default="50"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
              />
              <span class="mt-1 block text-xs text-slate-500">Display 1 through this level count.</span>
            </label>
            <label class="block md:col-span-2">
              <span class="text-sm text-slate-600">TP% List</span>
              <input
                id="inpBreakevenTpList"
                type="text"
                value="1, 2, 2.5, 3, 4, 5"
                data-default="1, 2, 2.5, 3, 4, 5"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                placeholder="Example: 0.5, 1, 1.5, 2"
              />
              <span class="mt-1 block text-xs text-slate-500">Separate values with commas. Each TP% creates a column.</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button
              type="submit"
              id="btnGenerateBreakeven"
              class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <ion-icon name="refresh-outline" class="text-base"></ion-icon>
              <span>Generate Matrix</span>
            </button>
            <button
              type="button"
              id="btnResetBreakeven"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-emerald-500/30"
            >
              <ion-icon name="refresh-circle-outline" class="text-base text-emerald-500"></ion-icon>
              <span>Reset</span>
            </button>
          </div>
        </form>
        <p class="text-xs text-slate-500">Cell shading cues required fills: green &le;100, yellow 101–300, orange 301–600, red &gt;600.</p>
        <div class="rounded-2xl border border-slate-200 bg-white overflow-x-auto" id="breakeven-matrix-table">
          <div class="p-4 text-sm text-slate-500">Adjust inputs above and click Generate to build the breakeven matrix.</div>
        </div>
      </section>
    </div>
  </div>
<script>
  (function(){
    const DEFAULT_PRICE_PRECISION = 2;
    const BREAKEVEN_DEFAULTS = {
      maxLevels: 15,
      tpList: '1,2,3,4,5'
    };
    const BREAKEVEN_SHADES = [
      { max: 100, className: 'bg-emerald-50 text-emerald-700' },
      { max: 300, className: 'bg-yellow-50 text-yellow-700' },
      { max: 600, className: 'bg-orange-50 text-orange-700' },
      { max: Infinity, className: 'bg-red-50 text-red-700' }
    ];
    let activeTab = 'grid-calculator';
    let LAST_GRID_JSON = '';
    let gridOverviewChart = null;
    let gridPlChart = null;
    let gridCashflowChart = null;

    function decimals(step) {
      if (!Number.isFinite(step)) return 0;
      const s = String(step);
      const idx = s.indexOf('.');
      return idx === -1 ? 0 : (s.length - idx - 1);
    }

    function roundTo(value, step) {
      const d = decimals(step);
      return Number(value.toFixed(d));
    }

    function snapToTick(value, tick) {
      if (!Number.isFinite(value) || !Number.isFinite(tick) || tick <= 0) return value;
      const snapped = Math.round(value / tick) * tick;
      const d = decimals(tick);
      return Number(snapped.toFixed(Math.min(Math.max(d, 0), 8)));
    }

    function adjustNumberInput(id, deltaUnits) {
      const el = document.getElementById(id);
      if (!el) return;
      const stepAttr = parseFloat(el.getAttribute('step') || '1');
      const step = Number.isFinite(stepAttr) && stepAttr > 0 ? stepAttr : 1;
      const minAttr = parseFloat(el.getAttribute('min'));
      const maxAttr = parseFloat(el.getAttribute('max'));
      const defAttr = parseFloat(el.getAttribute('data-default'));
      const curVal = parseFloat(el.value);
      const base = Number.isFinite(curVal) ? curVal : (Number.isFinite(defAttr) ? defAttr : 0);
      const next = base + (Number(deltaUnits) || 0) * step;
      const clamped = Math.min(Number.isFinite(maxAttr) ? maxAttr : Infinity, Math.max(Number.isFinite(minAttr) ? minAttr : -Infinity, next));
      const rounded = roundTo(clamped, step);
      el.value = String(rounded);
      el.dispatchEvent(new Event('change', { bubbles: true }));
      el.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function updateGridSizeLabel() {
      const label = document.getElementById('gridSizeLabel');
      const spacingType = (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase();
      if (label) {
        label.textContent = spacingType === 'percent' ? 'Grid Size (%)' : 'Grid Size ($)';
      }
      const input = document.getElementById('inpGridSize');
      if (input) {
        if (spacingType === 'percent') {
          input.min = '1';
          input.step = '1';
          input.setAttribute('min', '1');
          input.setAttribute('step', '1');
        } else {
          input.min = '0.5';
          input.step = '0.5';
          input.setAttribute('min', '0.5');
          input.setAttribute('step', '0.5');
        }
      }
      renderGridLadder();
    }

    function readNumericInput(id) {
      const el = document.getElementById(id);
      if (!el) return NaN;
      const val = parseFloat(el.value);
      return Number.isFinite(val) ? val : NaN;
    }

    function calculateGridLadder(params) {
      const rawStartPrice = Number(params?.startPrice);
      const spacingType = (params?.spacingType || 'percent').toLowerCase();
      const gridSize = Number(params?.gridSize);
      const levelCount = Math.max(0, Math.floor(Number(params?.levelCount ?? params?.rungCount)));
      const levelsUp = Math.max(0, Math.floor(Number(params?.levelsUp)));
      const tradeAmount = Math.max(0, Number(params?.tradeAmount));
      const tickSize = Number(params?.tickSize);
      const resolvedTickSize = Number.isFinite(tickSize) && tickSize > 0 ? tickSize : 0.01;
      const startPrice = snapToTick(rawStartPrice, resolvedTickSize);
      const precision = Math.max(DEFAULT_PRICE_PRECISION, decimals(resolvedTickSize));
      if (!Number.isFinite(startPrice) || startPrice <= 0) return { rows: [], summary: null, stepSize: null, precision };
      if (!Number.isFinite(gridSize) || gridSize <= 0) return { rows: [], summary: null, stepSize: null, precision };
      if (!Number.isFinite(levelCount) || levelCount <= 0) return { rows: [], summary: null, stepSize: null, precision };
      const perLevelInvestment = Number.isFinite(tradeAmount) && tradeAmount > 0 ? tradeAmount : 0;
      const investedForLevel = (level) => perLevelInvestment > 0 ? perLevelInvestment * level : 0;
      const entryPrices = perLevelInvestment > 0 ? [startPrice] : [];
      const computeTotalLoss = (currentPrice) => {
        if (perLevelInvestment <= 0 || !entryPrices.length) return 0;
        return entryPrices.reduce((sum, entryPrice) => {
          if (!Number.isFinite(entryPrice) || entryPrice <= 0) return sum;
          const dropFraction = Math.max(0, 1 - currentPrice / entryPrice);
          return sum + perLevelInvestment * dropFraction;
        }, 0);
      };

      const above = [];
      const below = [];
      const stepPercent = gridSize / 100;
      const usePercentSpacing = spacingType === 'percent';
      const aboveLimit = Math.max(0, Math.floor(levelsUp));

      let priceAccumulator = startPrice;
      let cumulativeSellCashflow = 0;
      let cumulativeSellProfit = 0;
      for (let i = 1; i <= aboveLimit; i++) {
        let price;
        if (usePercentSpacing) {
          const divisor = 1 - stepPercent;
          if (divisor <= 0) break;
          priceAccumulator = priceAccumulator / divisor;
          price = snapToTick(priceAccumulator, resolvedTickSize);
        } else {
          price = snapToTick(startPrice + gridSize * i, resolvedTickSize);
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        const trancheRevenue = perLevelInvestment > 0 ? perLevelInvestment * (price / startPrice) : 0;
        const trancheProfit = trancheRevenue - perLevelInvestment;
        if (perLevelInvestment > 0) {
          cumulativeSellCashflow += trancheRevenue;
          cumulativeSellProfit += trancheProfit;
        }
        above.push({
          key: `above-${i}`,
          type: 'above',
          label: `+${i}`,
          level: i,
          price,
          diff,
          diffPct,
          direction: 'Above',
          cashflow: cumulativeSellCashflow,
          profitLoss: cumulativeSellProfit,
          costBasis: investedForLevel(i)
        });
      }

      priceAccumulator = startPrice;
      for (let i = 1; i <= levelCount; i++) {
        let price;
        if (usePercentSpacing) {
          priceAccumulator = priceAccumulator * (1 - stepPercent);
          price = snapToTick(priceAccumulator, resolvedTickSize);
          if (price <= 0) break;
        } else {
          price = snapToTick(startPrice - gridSize * i, resolvedTickSize);
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        const totalLoss = computeTotalLoss(price);
        below.push({
          key: `below-${i}`,
          type: 'below',
          label: `-${i}`,
          level: i,
          price,
          diff,
          diffPct,
          direction: 'Below',
          cashflow: -investedForLevel(i),
          profitLoss: -totalLoss,
          costBasis: investedForLevel(i)
        });
        if (perLevelInvestment > 0) {
          entryPrices.push(price);
        }
      }

      const startRow = {
        key: 'start',
        type: 'start',
        label: 'Start',
        level: 0,
        price: startPrice,
        diff: 0,
        diffPct: 0,
        direction: 'Start',
        cashflow: 0,
        profitLoss: 0,
        costBasis: 0
      };

      const allRows = [...above, startRow, ...below];
      allRows.sort((a, b) => b.price - a.price);
      const stepSize = usePercentSpacing ? null : snapToTick(gridSize, resolvedTickSize);

      return {
        rows: allRows,
        summary: {
          startPrice,
          spacingType,
          gridSize,
          levelCount,
          tickSize: resolvedTickSize,
          aboveCount: above.length,
          belowCount: below.length
        },
        tradeAmount: perLevelInvestment,
        stepSize,
        precision
      };
    }

    function renderGridLadder() {
      const container = document.getElementById('gridLadderContainer');
      const summaryEl = document.getElementById('gridLadderSummary');
      if (!container) return;

      const params = {
        startPrice: readNumericInput('inpStartPrice'),
        spacingType: (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase(),
        gridSize: readNumericInput('inpGridSize'),
        levelCount: readNumericInput('inpLevelCount'),
        levelsUp: readNumericInput('inpLevelCountUp'),
        tradeAmount: readNumericInput('inpTradeAmount'),
        tickSize: readNumericInput('selTickSize')
      };
      const result = calculateGridLadder(params);
      if (!result.rows.length) {
        container.innerHTML = '<div class="p-4 text-sm text-slate-500">Enter a positive starting price, grid size, and levels down to draw the ladder.</div>';
        if (summaryEl) {
          summaryEl.textContent = 'Adjust the grid parameters to preview ladder levels around the starting price.';
        }
        updateGridOverviewChart(result);
        updateGridPlChart(result);
        updateGridCashflowChart(result);
        renderGridJson(result);
        return;
      }

      const { rows, summary, stepSize, precision, tradeAmount } = result;
      const priceFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const diffFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const pctFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const cashFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const showInvestmentMetrics = Number.isFinite(tradeAmount) && tradeAmount > 0;
      const perLevelInvestment = showInvestmentMetrics ? Number(tradeAmount) : 0;

      const spacingDescriptor = summary.spacingType === 'percent'
        ? `${Number(summary.gridSize).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 })}% per level (compounded)`
        : `$${diffFormatter.format(summary.gridSize)} spacing`;
      const stepDescriptor = Number.isFinite(stepSize)
        ? `≈ $${diffFormatter.format(stepSize)} between levels`
        : '';
      if (summaryEl) {
        const startStr = priceFormatter.format(summary.startPrice);
        const stepSuffix = stepDescriptor ? `, ${stepDescriptor}` : '';
        summaryEl.textContent = `Grid ladder: showing ${summary.aboveCount} level(s) above and ${summary.belowCount} level(s) below $${startStr} with ${spacingDescriptor}${stepSuffix}.`;
      }

      const rowHtml = rows.map(row => {
        const isStart = row.type === 'start';
        const diffClass = row.diff > 0 ? 'num-pos' : (row.diff < 0 ? 'num-neg' : 'text-slate-500');
        const pctClass = row.diffPct > 0 ? 'num-pos' : (row.diffPct < 0 ? 'num-neg' : 'text-slate-500');
        const diffAbs = diffFormatter.format(Math.abs(row.diff));
        const pctAbs = pctFormatter.format(Math.abs(row.diffPct));
        const diffText = row.diff === 0 ? `$${diffFormatter.format(0)}` : `${row.diff > 0 ? '+' : '-'}$${diffAbs}`;
        const pctText = row.diffPct === 0 ? `${pctFormatter.format(0)}%` : `${row.diffPct > 0 ? '+' : '-'}${pctAbs}%`;
        const cashflowValue = showInvestmentMetrics ? Number(row.cashflow) || 0 : 0;
        const cashflowText = showInvestmentMetrics
          ? (cashflowValue === 0 ? '$0.00' : `${cashflowValue > 0 ? '+' : '-'}$${cashFormatter.format(Math.abs(cashflowValue))}`)
          : '—';
        const cashflowClass = cashflowValue > 0 ? 'num-pos' : (cashflowValue < 0 ? 'num-neg' : 'text-slate-500');
        const profitLossValue = showInvestmentMetrics ? Number(row.profitLoss) || 0 : 0;
        const profitLossText = showInvestmentMetrics
          ? (profitLossValue === 0 ? '$0.00' : `${profitLossValue > 0 ? '+' : '-'}$${cashFormatter.format(Math.abs(profitLossValue))}`)
          : '—';
        const profitLossClass = profitLossValue > 0 ? 'num-pos' : (profitLossValue < 0 ? 'num-neg' : 'text-slate-500');
        const costBasis = showInvestmentMetrics ? Number(row.costBasis) || 0 : 0;
        const profitLossPctValue = costBasis > 0 ? (profitLossValue / costBasis) * 100 : 0;
        const profitLossPctText = showInvestmentMetrics
          ? (profitLossPctValue === 0 ? '0.00%' : `${profitLossPctValue > 0 ? '+' : '-'}${pctFormatter.format(Math.abs(profitLossPctValue))}%`)
          : '—';
        const profitLossPctClass = profitLossPctValue > 0 ? 'num-pos' : (profitLossPctValue < 0 ? 'num-neg' : 'text-slate-500');
        const baseCellClass = `px-4 py-2 text-sm ${isStart ? 'text-emerald-700 font-semibold' : 'text-slate-700'}`;
        return `
          <tr class="${isStart ? 'bg-emerald-50' : ''}">
            <td class="${baseCellClass}">${row.label}</td>
            <td class="${baseCellClass}">${row.direction}</td>
            <td class="${baseCellClass}">$${priceFormatter.format(row.price)}</td>
            <td class="px-4 py-2 text-sm ${diffClass}">${diffText}</td>
            <td class="px-4 py-2 text-sm ${pctClass}">${pctText}</td>
            <td class="px-4 py-2 text-sm ${cashflowClass}">${cashflowText}</td>
            <td class="px-4 py-2 text-sm ${profitLossClass}">${profitLossText}</td>
            <td class="px-4 py-2 text-sm ${profitLossPctClass}">${profitLossPctText}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-4 py-2 text-left">Level</th>
              <th scope="col" class="px-4 py-2 text-left">Direction</th>
              <th scope="col" class="px-4 py-2 text-left">Price</th>
              <th scope="col" class="px-4 py-2 text-left">Buy-and-Hold P/L ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Buy-and-Hold Return (%)</th>
              <th scope="col" class="px-4 py-2 text-left">Cashflow ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Grid P/L ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Grid P/L (%)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            ${rowHtml}
          </tbody>
        </table>
      `;

      updateGridOverviewChart(result);
      updateGridPlChart(result);
      updateGridCashflowChart(result);
      renderGridJson(result);
    }

    function updateGridOverviewChart(result) {
      const canvas = document.getElementById('gridOverviewChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridOverviewChart) {
          gridOverviewChart.destroy();
          gridOverviewChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const buyHold = chartRows.map((row) => Number(row?.diffPct) || 0);
      const gridPL = chartRows.map((row) => {
        const costBasis = Number(row?.costBasis) || 0;
        const profitLoss = Number(row?.profitLoss) || 0;
        if (costBasis <= 0) return 0;
        return (profitLoss / costBasis) * 100;
      });

      const data = {
        labels,
        datasets: [
          {
            label: 'Buy-and-Hold Return (%)',
            data: buyHold,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          },
          {
            label: 'Grid P/L (%)',
            data: gridPL,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Buy-and-Hold Return vs Grid P/L Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${value.toFixed(2)}%`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Return (%)' },
            ticks: {
              callback: (val) => `${val}%`
            }
          }
        }
      };

      if (gridOverviewChart) {
        gridOverviewChart.data = data;
        gridOverviewChart.options = options;
        gridOverviewChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridOverviewChart = new Chart(ctx, { type: 'line', data, options });
    }

    function updateGridPlChart(result) {
      const canvas = document.getElementById('gridPlChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridPlChart) {
          gridPlChart.destroy();
          gridPlChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const gridPL = chartRows.map((row) => Number(row?.profitLoss) || 0);
      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      const formatCurrency = (value) => {
        const sign = value < 0 ? '-' : '';
        return `${sign}$${currencyFormatter.format(Math.abs(value))}`;
      };

      const data = {
        labels,
        datasets: [
          {
            label: 'Grid P/L ($)',
            data: gridPL,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Grid Strategy Profit and Loss Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Grid P/L ($)' },
            ticks: {
              callback: (val) => formatCurrency(Number(val))
            }
          }
        }
      };

      if (gridPlChart) {
        gridPlChart.data = data;
        gridPlChart.options = options;
        gridPlChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridPlChart = new Chart(ctx, { type: 'line', data, options });
    }

    function updateGridCashflowChart(result) {
      const canvas = document.getElementById('gridCashflowChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridCashflowChart) {
          gridCashflowChart.destroy();
          gridCashflowChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const cashflow = chartRows.map((row) => Number(row?.cashflow) || 0);
      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      const formatCurrency = (value) => {
        const sign = value < 0 ? '-' : '';
        return `${sign}$${currencyFormatter.format(Math.abs(value))}`;
      };

      const data = {
        labels,
        datasets: [
          {
            label: 'Net Cashflow ($)',
            data: cashflow,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Net Cashflow Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Net Cashflow ($)' },
            ticks: {
              callback: (val) => formatCurrency(Number(val))
            }
          }
        }
      };

      if (gridCashflowChart) {
        gridCashflowChart.data = data;
        gridCashflowChart.options = options;
        gridCashflowChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridCashflowChart = new Chart(ctx, { type: 'line', data, options });
    }

    function buildGridJsonFromResult(result) {
      if (!result || !Array.isArray(result.rows) || !result.rows.length || !result.summary) return null;
      const precision = Number.isInteger(result.precision) ? result.precision : DEFAULT_PRICE_PRECISION;
      const pricePrecision = Math.max(precision, 2);
      const formatPrice = (val) => Number(val ?? 0).toFixed(pricePrecision);
      const summary = result.summary;
      const basePriceRaw = summary.startPrice || 0;
      const basePrice = formatPrice(basePriceRaw);
      const downRows = result.rows
        .filter(row => row.type === 'below')
        .sort((a, b) => b.price - a.price);
      const upRows = result.rows
        .filter(row => row.type === 'above')
        .sort((a, b) => a.price - b.price);

      const levelsDown = downRows.map((row, idx) => {
        const sellSource = idx === 0 ? (summary.startPrice || basePriceRaw) : downRows[idx - 1].price;
        return {
          buy: formatPrice(row.price),
          sell: formatPrice(sellSource),
          active: false,
          hide: false
        };
      });

      const levelsUp = upRows.map((row, idx) => {
        const buySource = idx === 0 ? basePriceRaw : upRows[idx - 1].price;
        return {
          buy: formatPrice(buySource),
          sell: formatPrice(row.price),
          active: false,
          hide: false
        };
      });

      const levels = [...levelsDown, ...levelsUp];
      const rawSize = Number(summary.gridSize);
      const spacingType = (summary.spacingType || 'percent').toLowerCase();
      const size = Number.isFinite(rawSize)
        ? (spacingType === 'percent' ? rawSize.toFixed(4) : formatPrice(rawSize))
        : formatPrice(0);
      return {
        grid: {
          base_price: basePrice,
          size,
          levels
        }
      };
    }

    function renderGridJson(result) {
      const codeEl = document.getElementById('gridJsonCode');
      const copyBtn = document.getElementById('btnCopyGridJson');
      const labelSpan = copyBtn?.querySelector('[data-copy-label]');
      const payload = buildGridJsonFromResult(result);
      if (!codeEl) return;
      if (!payload) {
        codeEl.textContent = '// Adjust grid inputs above to generate JSON.';
        LAST_GRID_JSON = '';
        if (copyBtn) {
          copyBtn.disabled = true;
          if (labelSpan) labelSpan.textContent = 'Copy JSON';
        }
        return;
      }
      const pretty = formatGridJson(payload);
      codeEl.textContent = pretty;
      LAST_GRID_JSON = pretty;
      if (copyBtn) {
        copyBtn.disabled = false;
        if (labelSpan) labelSpan.textContent = 'Copy JSON';
      }
    }
    
    function formatGridJson(payload) {
      const indent = (level) => '  '.repeat(level);
      const grid = payload?.grid || {};
      const levels = Array.isArray(grid.levels) ? grid.levels : [];
      const formatPrice = (val) => {
        if (typeof val === 'string') return val;
        const num = Number(val ?? 0);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };
      const formatSize = (val) => {
        if (typeof val === 'string') return val;
        const num = Number(val ?? 0);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };
      const lines = ['{', `${indent(1)}"grid": {`];
      lines.push(`${indent(2)}"base_price": ${formatPrice(grid.base_price)},`);
      lines.push(`${indent(2)}"size": ${formatSize(grid.size)},`);
      lines.push(`${indent(2)}"levels": [`);
      const sortedLevels = (Array.isArray(levels) ? levels : [])
        .map((level) => {
          const rawBuy = level?.buy ?? level?.buyPrice ?? level?.buy_price;
          const rawSell = level?.sell ?? level?.sellPrice ?? level?.sell_price;
          const parsedBuy = Number(rawBuy);
          return {
            rawBuy,
            rawSell,
            parsedBuy: Number.isFinite(parsedBuy) ? parsedBuy : 0,
            active: !!level?.active,
            hide: !!level?.hide
          };
        })
        .sort((a, b) => b.parsedBuy - a.parsedBuy);
      sortedLevels.forEach((level, idx) => {
        const comma = idx < sortedLevels.length - 1 ? ',' : '';
        const buy = formatPrice(level.rawBuy);
        const sell = formatPrice(level.rawSell);
        const active = level.active ? 'true' : 'false';
        const hide = level.hide ? 'true' : 'false';
        lines.push(`${indent(3)}{ "buy": ${buy}, "sell": ${sell}, "active": ${active}, "hide": ${hide} }${comma}`);
      });
      lines.push(`${indent(2)}]`);
      lines.push(`${indent(1)}}`, '}');
      return lines.join('\n');
    }

    async function copyGridJsonToClipboard(text) {
      if (!text) return false;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          // fall back to execCommand copy
        }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.pointerEvents = 'none';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (err) {
        return false;
      }
    }

    function getBreakevenCellClass(value) {
      if (!Number.isFinite(value)) return 'bg-slate-100 text-slate-500';
      for (const bucket of BREAKEVEN_SHADES) {
        if (value <= bucket.max) return bucket.className;
      }
      return 'bg-slate-100 text-slate-500';
    }

    function parseBreakevenTpValues(rawList) {
      const source = typeof rawList === 'string' && rawList.trim().length ? rawList : BREAKEVEN_DEFAULTS.tpList;
      return source
        .split(',')
        .map((part) => parseFloat(part.trim()))
        .filter((val) => Number.isFinite(val) && val > 0)
        .map((val) => Number(val.toFixed(4)));
    }

    function generateBreakevenMatrix() {
      const maxLevelsInput = document.getElementById('inpBreakevenLevels');
      const tpListInput = document.getElementById('inpBreakevenTpList');
      const tableContainer = document.getElementById('breakeven-matrix-table');
      if (!maxLevelsInput || !tpListInput || !tableContainer) return;

      const parsedLevels = parseInt(maxLevelsInput.value, 10);
      const clampedLevels = Math.max(1, Math.min(200, Number.isFinite(parsedLevels) ? parsedLevels : BREAKEVEN_DEFAULTS.maxLevels));
      if (String(clampedLevels) !== maxLevelsInput.value) {
        maxLevelsInput.value = String(clampedLevels);
      }

      const tpValues = parseBreakevenTpValues(tpListInput.value);
      if (!tpValues.length) {
        tableContainer.innerHTML = '<div class="p-4 text-sm text-slate-500">Enter at least one valid TP% (greater than 0) to generate the matrix.</div>';
        return;
      }

      const tpFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 });
      const fillsFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
      const headerCells = tpValues.map((tp) => `<th scope="col" class="px-4 py-2 text-center">${tpFormatter.format(tp)}%</th>`).join('');

      let bodyHtml = '';
      for (let level = 1; level <= clampedLevels; level++) {
        const rowClass = level % 2 === 0 ? 'bg-slate-50/70' : 'bg-white';
        const levelCell = `<td class="px-4 py-2 text-sm font-medium text-slate-700 text-left">${level}</td>`;
        const cells = tpValues.map((tp) => {
          const tpRatio = tp / 100;
          const fillsNeeded = tpRatio > 0 ? Math.ceil(level / tpRatio) : null;
          const cellClass = getBreakevenCellClass(fillsNeeded);
          const content = fillsNeeded != null ? fillsFormatter.format(fillsNeeded) : '—';
          return `<td class="px-4 py-2 text-sm font-semibold text-center ${cellClass}">${content}</td>`;
        }).join('');
        bodyHtml += `<tr class="${rowClass}">${levelCell}${cells}</tr>`;
      }

      tableContainer.innerHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-100 text-xs font-semibold uppercase tracking-wide text-slate-600">
            <tr>
              <th scope="col" class="px-4 py-2 text-left">Levels &darr;</th>
              ${headerCells}
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            ${bodyHtml}
          </tbody>
        </table>
      `;
    }

    function resetBreakevenInputs() {
      const levelInput = document.getElementById('inpBreakevenLevels');
      const tpInput = document.getElementById('inpBreakevenTpList');
      if (levelInput) levelInput.value = String(BREAKEVEN_DEFAULTS.maxLevels);
      if (tpInput) tpInput.value = BREAKEVEN_DEFAULTS.tpList;
      generateBreakevenMatrix();
    }

    function activateTab(tabName) {
      const normalized = tabName === 'breakeven-matrix' ? 'breakeven-matrix' : 'grid-calculator';
      activeTab = normalized;
      const buttons = document.querySelectorAll('[data-tab-button]');
      buttons.forEach((btn) => {
        const isActive = btn?.getAttribute('data-tab-button') === normalized;
        btn.classList.toggle('border-emerald-500', !!isActive);
        btn.classList.toggle('text-slate-900', !!isActive);
        btn.classList.toggle('text-slate-500', !isActive);
        btn.classList.toggle('border-transparent', !isActive);
        btn.classList.toggle('hover:text-slate-700', !isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      const panels = document.querySelectorAll('[data-tab-panel]');
      panels.forEach((panel) => {
        const isActive = panel?.getAttribute('data-tab-panel') === normalized;
        panel.classList.toggle('hidden', !isActive);
        if (isActive) {
          panel.removeAttribute('hidden');
        } else {
          panel.setAttribute('hidden', 'true');
        }
        panel.tabIndex = isActive ? 0 : -1;
      });
    }

    function setupTabs() {
      const buttons = document.querySelectorAll('[data-tab-button]');
      if (!buttons.length) return;
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-tab-button');
          activateTab(target);
        });
      });
      activateTab(activeTab);
    }

    function setupCarousel() {
      const carousel = document.getElementById('gridCarousel');
      if (!carousel) return;
      const track = carousel.querySelector('[data-carousel-track]');
      const slides = track ? Array.from(track.children) : [];
      if (!track || !slides.length) return;
      const prevBtn = carousel.querySelector('[data-carousel-prev]');
      const nextBtn = carousel.querySelector('[data-carousel-next]');
      const dots = Array.from(carousel.querySelectorAll('[data-carousel-dot]'));
      let index = 0;

      const update = () => {
        const maxIndex = slides.length - 1;
        index = Math.max(0, Math.min(index, maxIndex));
        track.style.transform = `translateX(-${index * 100}%)`;
        if (prevBtn) prevBtn.disabled = index === 0;
        if (nextBtn) nextBtn.disabled = index === maxIndex;
        dots.forEach((dot, idx) => {
          const isActive = idx === index;
          dot.classList.toggle('bg-emerald-500', isActive);
          dot.classList.toggle('bg-slate-300', !isActive);
          if (isActive) {
            dot.setAttribute('aria-current', 'true');
          } else {
            dot.removeAttribute('aria-current');
          }
        });
      };

      prevBtn?.addEventListener('click', () => {
        index -= 1;
        update();
      });
      nextBtn?.addEventListener('click', () => {
        index += 1;
        update();
      });
      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const nextIndex = Number(dot.getAttribute('data-carousel-dot'));
          if (Number.isFinite(nextIndex)) {
            index = nextIndex;
            update();
          }
        });
      });

      update();
    }

    document.addEventListener('click', (e) => {
      const controlBtn = e.target.closest('button[data-num-target][data-num-step]');
      if (controlBtn) {
        const id = controlBtn.getAttribute('data-num-target');
        const delta = parseFloat(controlBtn.getAttribute('data-num-step')) || 0;
        adjustNumberInput(id, delta);
        return;
      }
    });

    document.addEventListener('click', (e) => {
      const infoBtn = e.target.closest('[data-chart-info-toggle]');
      if (!infoBtn) return;
      const container = infoBtn.closest('.min-w-full') || document;
      const details = container.querySelector('[data-chart-info]');
      if (details) {
        details.open = !details.open;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      setupCarousel();
      updateGridSizeLabel();

      const spacingEl = document.getElementById('selGridSpacing');
      if (spacingEl) {
        spacingEl.addEventListener('change', updateGridSizeLabel);
      }

      const startEl = document.getElementById('inpStartPrice');
      if (startEl) {
        startEl.addEventListener('input', renderGridLadder);
        startEl.addEventListener('change', renderGridLadder);
      }

      const gridSizeEl = document.getElementById('inpGridSize');
      if (gridSizeEl) {
        gridSizeEl.addEventListener('input', renderGridLadder);
        gridSizeEl.addEventListener('change', renderGridLadder);
      }

      const tradeAmountEl = document.getElementById('inpTradeAmount');
      if (tradeAmountEl) {
        tradeAmountEl.addEventListener('input', renderGridLadder);
        tradeAmountEl.addEventListener('change', renderGridLadder);
      }

      const levelEl = document.getElementById('inpLevelCount');
      if (levelEl) {
        levelEl.addEventListener('input', renderGridLadder);
        levelEl.addEventListener('change', renderGridLadder);
      }

      const levelUpEl = document.getElementById('inpLevelCountUp');
      if (levelUpEl) {
        levelUpEl.addEventListener('input', renderGridLadder);
        levelUpEl.addEventListener('change', renderGridLadder);
      }

      const tickSizeEl = document.getElementById('selTickSize');
      if (tickSizeEl) {
        tickSizeEl.addEventListener('change', renderGridLadder);
      }

      const copyBtn = document.getElementById('btnCopyGridJson');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          if (!LAST_GRID_JSON) return;
          const labelSpan = copyBtn.querySelector('[data-copy-label]');
          const original = labelSpan?.textContent || 'Copy JSON';
          if (labelSpan) labelSpan.textContent = 'Copying…';
          copyBtn.classList.add('ring-1', 'ring-emerald-400/60');
          const success = await copyGridJsonToClipboard(LAST_GRID_JSON);
          if (success) {
            if (labelSpan) labelSpan.textContent = 'Copied!';
            copyBtn.classList.add('bg-emerald-600');
            setTimeout(() => {
              copyBtn.classList.remove('bg-emerald-600', 'ring-emerald-400/60', 'ring-1');
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          } else {
            copyBtn.classList.remove('ring-emerald-400/60', 'ring-1');
            if (labelSpan) labelSpan.textContent = 'Copy failed';
            setTimeout(() => {
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          }
        });
      }

      const breakevenForm = document.getElementById('breakevenMatrixForm');
      if (breakevenForm) {
        breakevenForm.addEventListener('submit', (event) => {
          event.preventDefault();
          generateBreakevenMatrix();
        });
      }

      const breakevenResetBtn = document.getElementById('btnResetBreakeven');
      if (breakevenResetBtn) {
        breakevenResetBtn.addEventListener('click', (event) => {
          event.preventDefault();
          resetBreakevenInputs();
        });
      }

      renderGridLadder();
      generateBreakevenMatrix();
    });
  })();
</script>
</body>
</html>
