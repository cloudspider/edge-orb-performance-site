
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grid Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"
  />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <!-- Apache ECharts for interactive charts (mobile pinch-zoom supported) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    .num-pos { color: #119d6e !important; }
    .num-neg { color: #ff0000 !important; }
    .pnl-strong { font-size: 1.8rem !important; }
    .sticky-th { position: sticky; top: 0; background: white; z-index: 1; }
    .shadow-soft { box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
    thead th { position: sticky; top: 0; background: white; z-index: 1; }

    /* Hide native spin buttons for key numeric inputs */
    #inp_orb_m::-webkit-outer-spin-button,
    #inp_orb_m::-webkit-inner-spin-button,
    #inp_target_R::-webkit-outer-spin-button,
    #inp_target_R::-webkit-inner-spin-button,
    #inp_stop_R::-webkit-outer-spin-button,
    #inp_stop_R::-webkit-inner-spin-button,
    #inp_risk_pct::-webkit-outer-spin-button,
    #inp_risk_pct::-webkit-inner-spin-button,
    #inp_aum0::-webkit-outer-spin-button,
    #inp_aum0::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #inp_orb_m,
    #inp_target_R,
    #inp_stop_R,
    #inp_risk_pct,
    #inp_aum0 {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Generic: hide spinners for any future number input */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Segment controls responsive layout */
    #tickerSegment {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      grid-auto-rows: 1fr;
      width: 100%;
      gap: 1px;
    }
    #tickerSegment button {
      width: 100%;
      height: 100%;
    }
    #sessionSegment {
      display: flex;
      flex-wrap: wrap;
      max-width: 100%;
      min-width: 0;
      white-space: normal;
    }
    #sessionSegment button {
      flex: 0 0 auto;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Site navigation -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-6 py-3 flex items-center gap-4">
      <div class="flex items-center gap-6 flex-1 min-w-0">
        <div class="flex items-center gap-2 font-semibold text-slate-800">
          <svg class="h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" aria-hidden="true"><path d="M192 384L88.5 384C63.6 384 48.3 356.9 61.1 335.5L114 247.3C122.7 232.8 138.3 224 155.2 224L250.2 224C326.3 95.1 439.8 88.6 515.7 99.7C528.5 101.6 538.5 111.6 540.3 124.3C551.4 200.2 544.9 313.7 416 389.8L416 484.8C416 501.7 407.2 517.3 392.7 526L304.5 578.9C283.2 591.7 256 576.3 256 551.5L256 448C256 412.7 227.3 384 192 384L191.9 384zM464 224C464 197.5 442.5 176 416 176C389.5 176 368 197.5 368 224C368 250.5 389.5 272 416 272C442.5 272 464 250.5 464 224z"/></svg>
          <span>ORB</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <a data-nav href="index.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Performance</a>
          <a data-nav href="backtest.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Backtest</a>
          <a data-nav href="results.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Results</a>
          <a data-nav href="pullback_grid.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Pullback Grid</a>
        </div>
      </div>
    </div>
  </nav>
  <script>
    // Activate nav item for current page
    (function(){
      try {
        const file = (location.pathname.split('/').pop() || 'pullback_grid.html').toLowerCase();
        document.querySelectorAll('a[data-nav]').forEach(a => {
          const href = (a.getAttribute('href') || '').toLowerCase();
          const active = href === file || (file === '' && href.endsWith('index.html'));
          a.classList.toggle('bg-slate-800', active);
          a.classList.toggle('text-white', active);
          a.classList.toggle('hover:bg-slate-100', !active);
          if (active) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
        });
      } catch {}
    })();
  </script>

  <div class="max-w-screen-2xl mx-auto p-6 space-y-6">
    <header class="mb-2">
      <h1 id="mainTitle" class="text-2xl md:text-3xl font-semibold">Grid</h1>
      <p class="text-slate-600 mt-1">Under construction. Hook up pullback grid datasets and controls here.</p>
    </header>

    <section id="symbolPicker" class="bg-white rounded-2xl shadow-soft p-3 md:p-4">
      <div class="overflow-x-auto -mx-3 md:mx-0 px-3 md:px-0">
        <nav class="flex min-w-max border-b border-slate-200 gap-1" role="tablist">
          <button type="button" class="inline-flex items-center gap-2 border-b-2 border-blue-500 px-3 py-2 text-sm font-medium text-slate-900 transition">
            <span class="inline-flex h-8 w-8 items-center justify-center text-emerald-500">
              <ion-icon name="grid-outline" class="text-2xl"></ion-icon>
            </span>
            <span>Grid Calculator</span>
          </button>
        </nav>
      </div>

      <div class="flex-1 min-w-0 mt-4">
        <div class="flex items-center gap-2 mb-2">
          <div class="flex-1 min-w-0">
            <div id="tickerSegment" class="w-full rounded-xl border border-slate-200 bg-slate-200 p-px overflow-hidden">
              <span class="px-3 py-1.5 text-sm text-slate-500">Loading…</span>
            </div>
          </div>
        </div>
        <div id="status" class="text-xs text-slate-500"></div>
      </div>
    </section>

    <section id="gridParameters" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
      <div class="flex flex-col gap-1">
        <h2 class="font-semibold text-slate-700">Grid Parameters</h2>
        <p id="dataSummary" class="text-sm text-slate-500">Select a symbol to load intraday data.</p>
      </div>
      <div class="grid gap-4 md:grid-cols-6">
        <label class="block">
          <span class="text-sm text-slate-600">Start Price ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpStartPrice"
              type="number"
              step="0.01"
              min="0"
              value="100"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase start price" data-num-target="inpStartPrice" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease start price" data-num-target="inpStartPrice" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Grid Type</span>
          <div class="relative mt-1">
            <select
              id="selGridType"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="pullback" selected>Buy-the-Dip Grid</option>
              <option value="progressive">Progressive Grid</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Grid Spacing</span>
          <div class="relative mt-1">
            <select
              id="selGridSpacing"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="fixed">Fixed Price</option>
              <option value="percent" selected>Percentage</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span id="gridSizeLabel" class="text-sm text-slate-600">Grid Size ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpGridSize"
              type="number"
              step="0.5"
              min="0.5"
              value="5"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase grid size" data-num-target="inpGridSize" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease grid size" data-num-target="inpGridSize" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Rungs per Side</span>
          <div class="mt-1 relative">
            <input
              id="inpRungCount"
              type="number"
              min="1"
              max="20"
              step="1"
              value="5"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase rung count" data-num-target="inpRungCount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease rung count" data-num-target="inpRungCount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Initial Capital ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpInitialCapital"
              type="number"
              min="0"
              step="100"
              value="10000"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase initial capital" data-num-target="inpInitialCapital" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease initial capital" data-num-target="inpInitialCapital" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Trade Amount ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpTradeAmount"
              type="number"
              min="0"
              step="50"
              value="1000"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase trade amount" data-num-target="inpTradeAmount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease trade amount" data-num-target="inpTradeAmount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
      </div>
    </section>

    <section id="gridLadderSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex flex-col gap-1">
        <h2 class="font-semibold text-slate-700">Grid Ladder Preview</h2>
        <p id="gridLadderSummary" class="text-sm text-slate-500">Adjust the grid parameters to preview ladder levels around the starting price.</p>
      </div>
      <div class="overflow-x-auto">
        <div id="gridLadderContainer" class="min-w-full rounded-xl border border-slate-200 bg-white">
          <div class="p-4 text-sm text-slate-500">Enter a valid starting price, grid size, and rung count to draw the ladder.</div>
        </div>
      </div>
    </section>

    <section id="gridJsonSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h2 class="font-semibold text-slate-700">Grid JSON Export</h2>
          <p class="text-sm text-slate-500">Copy the current ladder as JSON for scripting or sharing.</p>
        </div>
      </div>
      <div class="relative">
        <button
          type="button"
          id="btnCopyGridJson"
          class="absolute right-3 top-3 inline-flex items-center gap-2 rounded-lg border border-slate-600/30 bg-slate-800/80 px-3 py-1 text-xs font-medium text-white transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:bg-slate-700/50"
          disabled
        >
          <ion-icon name="copy-outline" class="text-base"></ion-icon>
          <span data-copy-label>Copy JSON</span>
        </button>
        <pre class="bg-slate-900 text-slate-100 rounded-2xl p-4 text-xs md:text-sm font-mono overflow-x-auto shadow-inner min-h-[140px]">
<code id="gridJsonCode">// Adjust grid inputs above to generate JSON.</code>
        </pre>
      </div>
    </section>
  </div>
<script>
  (function(){
    const DEFAULT_PRICE_PRECISION = 2;
    const pad2 = (n) => String(n).padStart(2, '0');
    const dateKeyFromStr = (val) => {
      if (val == null) return null;
      if (typeof val === 'string') {
        const m = val.trim().match(/^(\d{4}-\d{2}-\d{2})/);
        if (m) return m[1];
      }
      const d = new Date(val);
      if (isNaN(d)) return null;
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    };

    let currentTicker = '';
    let ROWS = [];
    let DAY_GROUPS = new Map();
    let DAYS = [];
    let SYMBOL_META = new Map();
    let LAST_GRID_JSON = '';

    function setStatus(msg) {
      const el = document.getElementById('status');
      if (el) el.textContent = msg || '';
    }

    function ensureSymbolMetaEntry(symbol) {
      const sym = (symbol || '').toUpperCase();
      if (!sym) return null;
      if (!SYMBOL_META.has(sym)) {
        SYMBOL_META.set(sym, { symbol: sym, name: sym, multiplier: 1, precision: DEFAULT_PRICE_PRECISION });
      }
      const meta = SYMBOL_META.get(sym);
      if (meta && !meta.symbol) meta.symbol = sym;
      return meta || null;
    }

    function countPriceDecimals(value) {
      if (!Number.isFinite(value)) return 0;
      const str = Number(value).toFixed(8).replace(/0+$/,'').replace(/\.$/,'');
      const idx = str.indexOf('.');
      return idx >= 0 ? (str.length - idx - 1) : 0;
    }

    function decimals(step) {
      if (!Number.isFinite(step)) return 0;
      const s = String(step);
      const idx = s.indexOf('.');
      return idx === -1 ? 0 : (s.length - idx - 1);
    }

    function roundTo(value, step) {
      const d = decimals(step);
      return Number(value.toFixed(d));
    }

    function adjustNumberInput(id, deltaUnits) {
      const el = document.getElementById(id);
      if (!el) return;
      const stepAttr = parseFloat(el.getAttribute('step') || '1');
      const step = Number.isFinite(stepAttr) && stepAttr > 0 ? stepAttr : 1;
      const minAttr = parseFloat(el.getAttribute('min'));
      const maxAttr = parseFloat(el.getAttribute('max'));
      const defAttr = parseFloat(el.getAttribute('data-default'));
      const curVal = parseFloat(el.value);
      const base = Number.isFinite(curVal) ? curVal : (Number.isFinite(defAttr) ? defAttr : 0);
      const next = base + (Number(deltaUnits) || 0) * step;
      const clamped = Math.min(Number.isFinite(maxAttr) ? maxAttr : Infinity, Math.max(Number.isFinite(minAttr) ? minAttr : -Infinity, next));
      const rounded = roundTo(clamped, step);
      el.value = String(rounded);
      el.dispatchEvent(new Event('change', { bubbles: true }));
      el.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function updateGridSizeLabel() {
      const label = document.getElementById('gridSizeLabel');
      const spacingType = (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase();
      if (label) {
        label.textContent = spacingType === 'percent' ? 'Grid Size (%)' : 'Grid Size ($)';
      }
      const input = document.getElementById('inpGridSize');
      if (input) {
        if (spacingType === 'percent') {
          input.min = '0.1';
          input.step = '0.1';
        } else {
          input.min = '0.5';
          input.step = '0.5';
        }
      }
      renderGridLadder();
    }

    function inferPricePrecisionFromRows(rows) {
      if (!Array.isArray(rows)) return DEFAULT_PRICE_PRECISION;
      let maxDecimals = 0;
      const limit = Math.min(rows.length, 400);
      for (let i = 0; i < limit; i++) {
        const row = rows[i];
        if (!row) continue;
        const values = [row.open, row.high, row.low, row.close];
        for (const val of values) {
          const decimals = countPriceDecimals(val);
          if (decimals > maxDecimals) {
            maxDecimals = decimals;
            if (maxDecimals >= 6) return 6;
          }
        }
      }
      return Math.min(Math.max(maxDecimals, DEFAULT_PRICE_PRECISION), 8);
    }

    function updateSymbolPrecisionFromRows(symbol, rows) {
      const sym = (symbol || '').toUpperCase();
      if (!sym) return;
      const precision = inferPricePrecisionFromRows(rows);
      const meta = ensureSymbolMetaEntry(sym);
      if (meta) {
        meta.precision = precision;
        SYMBOL_META.set(sym, meta);
      }
      renderGridLadder();
    }

    function readNumericInput(id) {
      const el = document.getElementById(id);
      if (!el) return NaN;
      const val = parseFloat(el.value);
      return Number.isFinite(val) ? val : NaN;
    }

    function resolveSymbolPrecision() {
      const sym = (currentTicker || '').toUpperCase();
      if (!sym) return DEFAULT_PRICE_PRECISION;
      const meta = SYMBOL_META.get(sym) || ensureSymbolMetaEntry(sym);
      if (!meta) return DEFAULT_PRICE_PRECISION;
      const precision = Number.isInteger(meta.precision) ? meta.precision : DEFAULT_PRICE_PRECISION;
      return Math.min(Math.max(precision, 0), 8);
    }

    function calculateGridLadder(params) {
      const startPrice = Number(params?.startPrice);
      const spacingType = (params?.spacingType || 'percent').toLowerCase();
      const gridSize = Number(params?.gridSize);
      const rungCount = Math.max(0, Math.floor(Number(params?.rungCount)));
      const gridType = (params?.gridType || 'pullback').toLowerCase();
      if (!Number.isFinite(startPrice) || startPrice <= 0) return { rows: [], summary: null, stepSize: null, precision: resolveSymbolPrecision() };
      if (!Number.isFinite(gridSize) || gridSize <= 0) return { rows: [], summary: null, stepSize: null, precision: resolveSymbolPrecision() };
      if (!Number.isFinite(rungCount) || rungCount <= 0) return { rows: [], summary: null, stepSize: null, precision: resolveSymbolPrecision() };

      const precision = resolveSymbolPrecision();
      const above = [];
      const below = [];
      const stepPercent = gridSize / 100;
      const usePercentSpacing = spacingType === 'percent';
      const aboveLimit = gridType === 'progressive'
        ? Math.min(rungCount, 2)
        : Math.min(rungCount, 1);

      let priceAccumulator = startPrice;
      for (let i = 1; i <= aboveLimit; i++) {
        let price;
        if (usePercentSpacing) {
          priceAccumulator = priceAccumulator * (1 + stepPercent);
          price = priceAccumulator;
        } else {
          price = startPrice + gridSize * i;
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        above.push({
          key: `above-${i}`,
          type: 'above',
          label: `+${i}`,
          rung: i,
          price,
          diff,
          diffPct,
          direction: 'Above'
        });
      }

      priceAccumulator = startPrice;
      for (let i = 1; i <= rungCount; i++) {
        let price;
        if (usePercentSpacing) {
          priceAccumulator = priceAccumulator * (1 - stepPercent);
          price = priceAccumulator;
          if (price <= 0) break;
        } else {
          price = startPrice - gridSize * i;
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        below.push({
          key: `below-${i}`,
          type: 'below',
          label: `-${i}`,
          rung: i,
          price,
          diff,
          diffPct,
          direction: 'Below'
        });
      }

      const startRow = {
        key: 'start',
        type: 'start',
        label: 'Start',
        rung: 0,
        price: startPrice,
        diff: 0,
        diffPct: 0,
        direction: 'Start'
      };

      const allRows = [...above, startRow, ...below];
      allRows.sort((a, b) => b.price - a.price);
      const stepSize = usePercentSpacing ? null : gridSize;

      return {
        rows: allRows,
        summary: {
          startPrice,
          spacingType,
          gridSize,
          gridType,
          rungCount,
          aboveCount: above.length,
          belowCount: below.length
        },
        stepSize,
        precision
      };
    }

    function renderGridLadder() {
      const container = document.getElementById('gridLadderContainer');
      const summaryEl = document.getElementById('gridLadderSummary');
      if (!container) return;

      const params = {
        startPrice: readNumericInput('inpStartPrice'),
        spacingType: (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase(),
        gridSize: readNumericInput('inpGridSize'),
        rungCount: readNumericInput('inpRungCount'),
        gridType: (document.getElementById('selGridType')?.value || 'pullback').toLowerCase()
      };
      const result = calculateGridLadder(params);
      if (!result.rows.length) {
        container.innerHTML = '<div class="p-4 text-sm text-slate-500">Enter a positive starting price, grid size, and rung count to draw the ladder.</div>';
        if (summaryEl) {
          summaryEl.textContent = 'Adjust the grid parameters to preview ladder levels around the starting price.';
        }
        renderGridJson(result);
        return;
      }

      const { rows, summary, stepSize, precision } = result;
      const priceFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const diffFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const pctFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      const spacingDescriptor = summary.spacingType === 'percent'
        ? `${Number(summary.gridSize).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 })}% per rung (compounded)`
        : `$${diffFormatter.format(summary.gridSize)} spacing`;
      const stepDescriptor = Number.isFinite(stepSize)
        ? `≈ $${diffFormatter.format(stepSize)} between levels`
        : '';
      if (summaryEl) {
        const startStr = priceFormatter.format(summary.startPrice);
        const stepSuffix = stepDescriptor ? `, ${stepDescriptor}` : '';
        const gridTypeLabel = summary.gridType === 'progressive' ? 'Progressive' : 'Buy-the-Dip';
        summaryEl.textContent = `${gridTypeLabel} grid: showing ${summary.aboveCount} rung(s) above and ${summary.belowCount} rung(s) below $${startStr} with ${spacingDescriptor}${stepSuffix}.`;
      }

      const rowHtml = rows.map(row => {
        const isStart = row.type === 'start';
        const diffClass = row.diff > 0 ? 'num-pos' : (row.diff < 0 ? 'num-neg' : 'text-slate-500');
        const pctClass = row.diffPct > 0 ? 'num-pos' : (row.diffPct < 0 ? 'num-neg' : 'text-slate-500');
        const diffAbs = diffFormatter.format(Math.abs(row.diff));
        const pctAbs = pctFormatter.format(Math.abs(row.diffPct));
        const diffText = row.diff === 0 ? `$${diffFormatter.format(0)}` : `${row.diff > 0 ? '+' : '-'}$${diffAbs}`;
        const pctText = row.diffPct === 0 ? `${pctFormatter.format(0)}%` : `${row.diffPct > 0 ? '+' : '-'}${pctAbs}%`;
        const baseCellClass = `px-4 py-2 text-sm ${isStart ? 'text-emerald-700 font-semibold' : 'text-slate-700'}`;
        return `
          <tr class="${isStart ? 'bg-emerald-50' : ''}">
            <td class="${baseCellClass}">${row.label}</td>
            <td class="${baseCellClass}">${row.direction}</td>
            <td class="${baseCellClass}">$${priceFormatter.format(row.price)}</td>
            <td class="px-4 py-2 text-sm ${diffClass}">${diffText}</td>
            <td class="px-4 py-2 text-sm ${pctClass}">${pctText}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-4 py-2 text-left">Rung</th>
              <th scope="col" class="px-4 py-2 text-left">Direction</th>
              <th scope="col" class="px-4 py-2 text-left">Price</th>
              <th scope="col" class="px-4 py-2 text-left">Distance ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Distance (%)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            ${rowHtml}
          </tbody>
        </table>
      `;

      renderGridJson(result);
    }

    function buildGridJsonFromResult(result) {
      if (!result || !Array.isArray(result.rows) || !result.rows.length || !result.summary) return null;
      const precision = Number.isInteger(result.precision) ? result.precision : DEFAULT_PRICE_PRECISION;
      const formatPrice = (val) => Number(Number(val).toFixed(precision));
      const basePrice = formatPrice(result.summary.startPrice || 0);
      const buyRows = result.rows.filter(row => row.type === 'below').sort((a, b) => b.price - a.price);
      const buyLevels = buyRows.map(row => ({ price: formatPrice(row.price) }));
      const gridType = result.summary.gridType || 'pullback';
      const sellPrices = [];
      if (gridType === 'progressive') {
        sellPrices.push(basePrice);
        const aboveRows = result.rows.filter(row => row.type === 'above').sort((a, b) => b.price - a.price);
        aboveRows.forEach(row => sellPrices.push(formatPrice(row.price)));
      } else {
        if (buyLevels.length) {
          sellPrices.push(basePrice);
          for (let i = 0; i < buyLevels.length - 1; i++) {
            sellPrices.push(buyLevels[i].price);
          }
        } else {
          sellPrices.push(basePrice);
        }
      }
      const sellLevels = sellPrices.map(price => ({ price }));
      return {
        grid: {
          base_price: basePrice,
          buy_levels: buyLevels,
          sell_levels: sellLevels
        }
      };
    }

    function renderGridJson(result) {
      const codeEl = document.getElementById('gridJsonCode');
      const copyBtn = document.getElementById('btnCopyGridJson');
      const labelSpan = copyBtn?.querySelector('[data-copy-label]');
      const payload = buildGridJsonFromResult(result);
      if (!codeEl) return;
      if (!payload) {
        codeEl.textContent = '// Adjust grid inputs above to generate JSON.';
        LAST_GRID_JSON = '';
        if (copyBtn) {
          copyBtn.disabled = true;
          if (labelSpan) labelSpan.textContent = 'Copy JSON';
        }
        return;
      }
      const pretty = formatGridJson(payload);
      codeEl.textContent = pretty;
      LAST_GRID_JSON = pretty;
      if (copyBtn) {
        copyBtn.disabled = false;
        if (labelSpan) labelSpan.textContent = 'Copy JSON';
      }
    }
    
    function formatGridJson(payload) {
      const indent = (level) => '  '.repeat(level);
      const lines = ['{', `${indent(1)}"grid": {`];
      const grid = payload?.grid || {};
      const buyLevels = Array.isArray(grid.buy_levels) ? grid.buy_levels : [];
      const sellLevels = Array.isArray(grid.sell_levels) ? grid.sell_levels : [];
      lines.push(`${indent(2)}"base_price": ${grid.base_price},`);
      lines.push(`${indent(2)}"buy_levels": [`);
      buyLevels.forEach((level, idx) => {
        const comma = idx < buyLevels.length - 1 ? ',' : '';
        lines.push(`${indent(3)}{ "price": ${level.price} }${comma}`);
      });
      lines.push(`${indent(2)}],`);
      lines.push(`${indent(2)}"sell_levels": [`);
      sellLevels.forEach((level, idx) => {
        const comma = idx < sellLevels.length - 1 ? ',' : '';
        lines.push(`${indent(3)}{ "price": ${level.price} }${comma}`);
      });
      lines.push(`${indent(2)}]`);
      lines.push(`${indent(1)}}`, '}');
      return lines.join('\n');
    }

    async function copyGridJsonToClipboard(text) {
      if (!text) return false;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          // fall back to execCommand copy
        }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.pointerEvents = 'none';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (err) {
        return false;
      }
    }

    function highlightTickerButton(symbol) {
      const seg = document.getElementById('tickerSegment');
      if (!seg) return;
      const upper = (symbol || '').toUpperCase();
      seg.querySelectorAll('button[data-symbol]').forEach(btn => {
        const active = (btn.getAttribute('data-symbol') || '').toUpperCase() === upper;
        btn.classList.toggle('bg-emerald-600', active);
        btn.classList.toggle('text-white', active);
        btn.classList.toggle('hover:bg-emerald-600', active);
        btn.classList.toggle('bg-white', !active);
        btn.classList.toggle('hover:bg-emerald-50', !active);
        const nameSpan = btn.querySelector('[data-symbol-name]');
        if (nameSpan) {
          nameSpan.classList.toggle('text-emerald-100', active);
          nameSpan.classList.toggle('text-slate-500', !active);
        }
      });
    }

    function renderDataSummary() {
      const summaryEl = document.getElementById('dataSummary');
      if (!summaryEl) return;
      if (!currentTicker) {
        summaryEl.textContent = 'Select a symbol to load intraday data.';
        return;
      }
      if (!ROWS.length) {
        summaryEl.innerHTML = `<span class="font-semibold">${currentTicker}</span> selected. Choose another symbol or verify data files exist in the <code>data/</code> folder.`;
        return;
      }
      const firstDay = DAYS[0];
      const lastDay = DAYS[DAYS.length - 1];
      summaryEl.innerHTML = `
        <span class="font-semibold">${currentTicker}</span> loaded
        <span class="font-medium">${ROWS.length.toLocaleString()}</span> bars across
        <span class="font-medium">${DAYS.length.toLocaleString()}</span> trading day(s)
        (${firstDay || 'n/a'} → ${lastDay || 'n/a'}).
      `;
    }

    function setTicker(sym) {
      currentTicker = (sym || '').toUpperCase();
      const titleEl = document.getElementById('mainTitle');
      const meta = ensureSymbolMetaEntry(currentTicker);
      const friendlyName = meta && meta.name && meta.name.toUpperCase() !== currentTicker ? ` · ${meta.name}` : '';
      const fullTitle = currentTicker ? `${currentTicker}${friendlyName} - Grid Calculator` : 'Grid Calculator';
      if (titleEl) titleEl.textContent = fullTitle;
      document.title = fullTitle;
      highlightTickerButton(currentTicker);
      renderDataSummary();
      renderGridLadder();
    }

    function normalizeAndIndex(rows) {
      if (!rows || !rows.length) {
        ROWS = [];
        DAY_GROUPS = new Map();
        DAYS = [];
        return;
      }
      const required = ['caldt', 'day', 'open', 'high', 'low', 'close'];
      const missing = required.filter(c => !(c in rows[0]));
      if (missing.length) throw new Error('Missing columns: ' + missing.join(', '));

      ROWS = rows.map(r => {
        const caldt = new Date(r.caldt);
        const dayKey = dateKeyFromStr(r.day);
        const open = Number(r.open), high = Number(r.high), low = Number(r.low), close = Number(r.close);
        if (!dayKey || isNaN(caldt)) return null;
        if ([open, high, low, close].some(v => !Number.isFinite(v))) return null;
        return { caldt, dayKey, open, high, low, close };
      }).filter(Boolean);

      DAY_GROUPS = new Map();
      for (const row of ROWS) {
        if (!DAY_GROUPS.has(row.dayKey)) DAY_GROUPS.set(row.dayKey, []);
        DAY_GROUPS.get(row.dayKey).push(row);
      }
      for (const [key, arr] of DAY_GROUPS.entries()) arr.sort((a, b) => a.caldt - b.caldt);
      DAYS = Array.from(DAY_GROUPS.keys()).sort();
    }

    async function loadSymbolData(sym) {
      const baseSymbol = (sym || '').trim();
      if (!baseSymbol) return false;
      const upper = baseSymbol.toUpperCase();
      if (!SYMBOL_META.has(upper)) {
        setStatus(`No metadata available for ${upper}.`);
        return false;
      }
      setStatus(`Selected ${upper}. Configure grid parameters below.`);
      ROWS = [];
      DAY_GROUPS = new Map();
      DAYS = [];
      renderDataSummary();
      renderGridLadder();
      return true;
    }

    function normalizeSymbolEntries(entries) {
      const map = new Map();
      const ordered = [];
      if (!Array.isArray(entries)) return { list: ordered, map };
      for (const entry of entries) {
        let symbol = '';
        let name = '';
        let multiplier = null;
        if (typeof entry === 'string') {
          symbol = entry;
          name = entry;
        } else if (entry && typeof entry === 'object') {
          symbol = entry.symbol;
          name = entry.name || entry.symbol || '';
          multiplier = entry.multiplier;
        } else {
          continue;
        }
        symbol = (symbol || '').toUpperCase().trim();
        if (!symbol || map.has(symbol)) continue;
        const existing = SYMBOL_META.get(symbol) || null;
        const parsedMultiplier = Number(multiplier);
        const finalMultiplier = Number.isFinite(parsedMultiplier) && parsedMultiplier > 0
          ? parsedMultiplier
          : (existing && Number.isFinite(existing.multiplier) ? existing.multiplier : 1);
        const providedPrecision = entry && typeof entry === 'object' && Number.isInteger(entry.precision) && entry.precision >= 0
          ? Math.min(entry.precision, 8)
          : null;
        const meta = {
          symbol,
          name: (typeof name === 'string' && name.trim()) ? name.trim() : (existing && existing.name ? existing.name : symbol),
          multiplier: finalMultiplier,
          precision: providedPrecision != null
            ? providedPrecision
            : (existing && Number.isInteger(existing.precision) ? existing.precision : null)
        };
        map.set(symbol, meta);
        ordered.push(meta);
      }
      return { list: ordered, map };
    }

    async function populateTickerSegment() {
      const container = document.getElementById('tickerSegment');
      if (!container) return;
      container.innerHTML = '<span class="px-3 py-1.5 text-sm text-slate-500">Loading…</span>';
      const render = (entries) => {
        const normalized = normalizeSymbolEntries(entries);
        SYMBOL_META = normalized.map instanceof Map ? normalized.map : new Map();
        const list = Array.isArray(normalized.list) ? normalized.list : [];
        container.innerHTML = '';
        if (!list.length) {
          container.innerHTML = '<span class="px-3 py-1.5 text-sm text-slate-500">No symbols available.</span>';
          highlightTickerButton(currentTicker);
          return;
        }
        list.forEach((meta) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'w-full h-full px-3 py-2 text-left bg-white hover:bg-emerald-50 transition flex flex-col justify-center gap-0.5 leading-tight';
          btn.setAttribute('data-symbol', meta.symbol);
          btn.setAttribute('title', meta.name);
          btn.dataset.multiplier = String(meta.multiplier);
          btn.innerHTML = `
            <span class="text-sm font-semibold">${meta.symbol}</span>
            <span class="text-xs text-slate-500" data-symbol-name>${meta.name}</span>
          `;
          container.appendChild(btn);
        });
        highlightTickerButton(currentTicker);
        if (!currentTicker && list[0]) {
          setTicker(list[0].symbol);
          loadSymbolData(list[0].symbol);
        }
      };
      try {
        const res = await fetch('data/index.json', { cache: 'no-cache' });
        if (res.ok) {
          const list = await res.json();
          if (Array.isArray(list) && list.length) { render(list); return; }
        }
      } catch (err) {
        console.warn('Failed to load index.json', err);
      }
      try {
        const res = await fetch('data/', { cache: 'no-cache' });
        if (res.ok) {
          const text = await res.text();
          const ct = (res.headers.get('content-type') || '').toLowerCase();
          let files = [];
          if (ct.includes('text/html')) {
            const doc = new DOMParser().parseFromString(text, 'text/html');
            files = Array.from(doc.querySelectorAll('a')).map(a => a.getAttribute('href')).filter(Boolean);
          } else {
            files = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          }
          const regex = /^([A-Za-z0-9-]+)_1m\.csv$/i;
          const syms = [];
          for (const f of files) {
            const name = (f || '').split('/').pop();
            const m = name.match(regex);
            if (m) syms.push({ symbol: m[1].toUpperCase(), name: m[1].toUpperCase(), multiplier: undefined });
          }
          if (syms.length) { render(syms); return; }
        }
      } catch (err) {
        console.warn('Failed to enumerate data directory', err);
      }
      render(['TQQQ', 'TSLA', 'PLTR', 'UVXY']);
    }

    document.addEventListener('click', (e) => {
      const controlBtn = e.target.closest('button[data-num-target][data-num-step]');
      if (controlBtn) {
        const id = controlBtn.getAttribute('data-num-target');
        const delta = parseFloat(controlBtn.getAttribute('data-num-step')) || 0;
        adjustNumberInput(id, delta);
        return;
      }
    });

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('#tickerSegment button[data-symbol]');
      if (!btn) return;
      const symbol = btn.getAttribute('data-symbol');
      if (!symbol) return;
      setTicker(symbol);
      loadSymbolData(symbol);
    });

    document.addEventListener('DOMContentLoaded', () => {
      populateTickerSegment();
      updateGridSizeLabel();

      const spacingEl = document.getElementById('selGridSpacing');
      if (spacingEl) {
        spacingEl.addEventListener('change', updateGridSizeLabel);
      }

      const startEl = document.getElementById('inpStartPrice');
      if (startEl) {
        startEl.addEventListener('input', renderGridLadder);
        startEl.addEventListener('change', renderGridLadder);
      }

      const gridSizeEl = document.getElementById('inpGridSize');
      if (gridSizeEl) {
        gridSizeEl.addEventListener('input', renderGridLadder);
        gridSizeEl.addEventListener('change', renderGridLadder);
      }

      const rungEl = document.getElementById('inpRungCount');
      if (rungEl) {
        rungEl.addEventListener('input', renderGridLadder);
        rungEl.addEventListener('change', renderGridLadder);
      }

      const gridTypeEl = document.getElementById('selGridType');
      if (gridTypeEl) {
        gridTypeEl.addEventListener('change', renderGridLadder);
      }

      const copyBtn = document.getElementById('btnCopyGridJson');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          if (!LAST_GRID_JSON) return;
          const labelSpan = copyBtn.querySelector('[data-copy-label]');
          const original = labelSpan?.textContent || 'Copy JSON';
          if (labelSpan) labelSpan.textContent = 'Copying…';
          copyBtn.classList.add('ring-1', 'ring-emerald-400/60');
          const success = await copyGridJsonToClipboard(LAST_GRID_JSON);
          if (success) {
            if (labelSpan) labelSpan.textContent = 'Copied!';
            copyBtn.classList.add('bg-emerald-600');
            setTimeout(() => {
              copyBtn.classList.remove('bg-emerald-600', 'ring-emerald-400/60', 'ring-1');
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          } else {
            copyBtn.classList.remove('ring-emerald-400/60', 'ring-1');
            if (labelSpan) labelSpan.textContent = 'Copy failed';
            setTimeout(() => {
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          }
        });
      }

      renderGridLadder();
    });
  })();
</script>
</body>
</html>
