
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grid Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"
  />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <!-- Apache ECharts for interactive charts (mobile pinch-zoom supported) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --color-slate-900: #0f172a;
      --color-slate-300: #cbd5e1;
      --color-slate-200: #e2e8f0;
      --color-slate-600: #475569;
      --color-emerald-500: #10b981;
      --color-violet-500: #a855f7;
      --radius-pill: 999px;
      --app-bg: #f8fafc;
      --app-surface: #ffffff;
      --app-surface-muted: #f1f5f9;
      --app-surface-strong: #e2e8f0;
      --app-border: #e2e8f0;
      --app-border-muted: rgba(148, 163, 184, 0.4);
      --app-text: #0f172a;
      --app-text-muted: #475569;
      --app-text-subtle: #94a3b8;
      --app-header-bg: rgba(255, 255, 255, 0.9);
      --app-header-border: #e2e8f0;
      --app-sidebar-bg: #f8fafc;
      --app-tabbar-bg: #ffffff;
      --app-shadow-soft: 0 25px 45px rgba(15, 23, 42, 0.08);
      --app-shadow-elevated: 0 16px 32px rgba(15, 23, 42, 0.12);
      --app-log-bg: #0b1221;
      --app-log-border: rgba(148, 163, 184, 0.35);
      --app-chart-card-bg: #ffffff;
      --app-chart-card-border: rgba(226, 232, 240, 0.9);
      --app-chart-stat-bg: rgba(241, 245, 249, 0.9);
      --app-chart-stat-border: rgba(226, 232, 240, 0.9);
      --app-chart-dot: rgba(148, 163, 184, 0.8);
      --app-chart-dot-hover: rgba(100, 116, 139, 0.9);
      --app-chart-overlay-bg: rgba(255, 255, 255, 0.82);
      --app-chart-key-harvest: rgba(16, 185, 129, 0.95);
      --app-chart-key-cash: rgba(139, 92, 246, 0.95);
      --app-chart-axis-text: #64748b;
      --app-chart-grid: rgba(226, 232, 240, 0.9);
      --app-chart-legend-text: #334155;
      --app-chart-cash-line: rgba(139, 92, 246, 0.95);
      --app-chart-cash-fill: rgba(139, 92, 246, 0.1);
      --app-chart-harvest-line: rgba(16, 185, 129, 0.95);
      --app-chart-harvest-fill: rgba(16, 185, 129, 0.1);
      --app-overlay-bg: rgba(15, 23, 42, 0.75);
      --app-overlay-text: #ffffff;
      --app-badge-warning-bg: rgba(251, 146, 60, 0.15);
      --app-badge-warning-border: rgba(251, 146, 60, 0.35);
      --app-badge-warning-text: #c2410c;
      --app-badge-neutral-bg: rgba(148, 163, 184, 0.15);
      --app-badge-info-hover: rgba(59, 130, 246, 0.12);
      --app-badge-info-bg: rgba(59, 130, 246, 0.18);
      --app-badge-info-border: rgba(59, 130, 246, 0.8);
      --app-badge-info-ring: rgba(59, 130, 246, 0.25);
      --app-badge-info-text: #e0f2fe;
      --app-badge-success-hover: rgba(16, 185, 129, 0.14);
      --app-badge-success-bg: rgba(16, 185, 129, 0.18);
      --app-badge-success-border: rgba(16, 185, 129, 0.75);
      --app-badge-success-ring: rgba(16, 185, 129, 0.25);
      --app-badge-success-text: #dcfce7;
      --app-live-badge-on-bg: #10b981;
      --app-live-badge-on-text: #ffffff;
      --app-live-badge-off-bg: #e2e8f0;
      --app-live-badge-off-text: #64748b;
      --app-live-badge-off-border: #cbd5e1;
      --app-alert-warning-bg: #fffbeb;
      --app-alert-warning-border: #fde68a;
      --app-alert-warning-text: #92400e;
      --app-status-inactive-bg: #f2f2f2;
      --app-status-idle-bg: var(--color-slate-300);
      --app-status-armed-bg: #69e499;
      --app-status-waiting-bg: #ff5654;
      --app-status-orphan-bg: var(--color-violet-500);
      --app-card-buy-bg: #69e499;
      --app-card-buy-border: #7bd79f;
      --app-card-sell-bg: #ffa3a2;
      --app-card-sell-border: #f97374;
      --app-split-buy-bg: #c7f5d9;
      --app-split-sell-bg: #ff3d3b;
      --app-market-open-bg: linear-gradient(135deg, #ecfdf3, #dcfce7);
      --app-market-open-border: #34d399;
      --app-market-open-text: #065f46;
      --app-market-open-shadow: 0 15px 35px rgba(16, 185, 129, 0.2);
      --app-market-open-icon-bg: #d1fae5;
      --app-market-open-icon-text: #047857;
      --app-market-closed-bg: linear-gradient(135deg, #fef2f2, #fee2e2);
      --app-market-closed-border: #fca5a5;
      --app-market-closed-text: #991b1b;
      --app-market-closed-shadow: 0 15px 35px rgba(248, 113, 113, 0.2);
      --app-market-closed-icon-bg: #fee2e2;
      --app-market-closed-icon-text: #b91c1c;
      --app-market-guard-bg: linear-gradient(135deg, #fffbeb, #fef3c7);
      --app-market-guard-border: #facc15;
      --app-market-guard-text: #854d0e;
      --app-market-guard-shadow: 0 15px 35px rgba(250, 204, 21, 0.18);
      --app-market-guard-icon-bg: #fef9c3;
      --app-market-guard-icon-text: #a16207;
      --app-pill-neutral-bg: linear-gradient(135deg, var(--color-slate-200), #f8fafc);
      --app-pill-neutral-border: var(--color-slate-300);
      --app-pill-neutral-text: var(--color-slate-900);
      --app-pill-buy-bg: linear-gradient(135deg, var(--color-emerald-500), #34d399);
      --app-pill-buy-border: #059669;
      --app-pill-buy-text: #ecfdf3;
      --app-pill-sell-bg: linear-gradient(135deg, #f43f5e, #ef4444);
      --app-pill-sell-border: #e11d48;
      --app-pill-sell-text: #fff1f2;
      --app-accent: #2563eb;
      --app-accent-strong: #1d4ed8;
      --app-scrollbar-thumb: rgba(148, 163, 184, 0.6);
      --app-sort-indicator: #cbd5f5;
      --app-spinner-border: rgba(148, 163, 184, 0.6);
      --app-tooltip-bg: #0f172a;
      --app-tooltip-text: #f1f5f9;
      --app-tooltip-shadow: 0 20px 45px rgba(15, 23, 42, 0.4);
      --app-tooltip-button-bg: #0f172a;
      --app-tooltip-button-border: rgba(255, 255, 255, 0.15);
      --app-tooltip-button-text: #f1f5f9;
      --app-tooltip-button-hover-bg: #111b33;
      --app-tooltip-button-hover-border: rgba(16, 185, 129, 0.35);
      --app-tooltip-button-ring: rgba(52, 211, 153, 0.6);
      --app-tooltip-button-success-bg: #10b981;
      --app-tooltip-button-success-border: #10b981;
      --app-tooltip-button-success-text: #f8fbff;
      --app-tooltip-close-bg: rgba(15, 23, 42, 0.6);
      --app-tooltip-close-hover-bg: rgba(15, 23, 42, 0.9);
      --app-tooltip-close-text: #cbd5f5;
      --app-tooltip-close-hover-text: #ffffff;
      --app-tooltip-code-bg: rgba(255, 255, 255, 0.08);
      --app-tooltip-code-border: rgba(255, 255, 255, 0.12);
      --app-focus-ring: rgba(16, 185, 129, 0.7);
      --app-segment-active-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
      --app-pull-bg: rgba(248, 250, 252, 0.92);
      --app-pull-border: rgba(148, 163, 184, 0.5);
      --app-pull-text: #475569;
      --app-pull-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
      --app-border-strong: #cbd5e1;
      --app-row-hover-bg: rgba(16, 185, 129, 0.08);
      --app-row-selected-bg: rgba(16, 185, 129, 0.16);
      --app-row-selected-ring: rgba(16, 185, 129, 0.4);
      --app-checkbox-border: #94a3b8;
      --app-checkbox-bg: #ffffff;
      --app-checkbox-indeterminate-bg: #e2e8f0;
      --app-checkbox-indeterminate-border: #94a3b8;
      --app-checkbox-indeterminate-icon: #64748b;
      --app-level-metric-bg: rgba(241, 245, 249, 0.9);
      --app-level-metric-border: rgba(226, 232, 240, 0.9);
      --app-level-metric-label: rgba(100, 116, 139, 0.95);
      --app-level-bar-bg: #f1f5f9;
      --app-level-bar-border: rgba(15, 23, 42, 0.06);
      --app-level-bar-divider: rgba(15, 23, 42, 0.18);
      --app-level-marker: rgba(15, 23, 42, 0.25);
      --app-level-price-label: #1f2937;
      --app-level-price-dot: #0ee932;
      --app-level-price-dot-border: #ecfeff;
      --app-level-price-dot-shadow: 0 2px 6px rgba(14, 165, 233, 0.4);
      --app-menu-bg: #0f172a;
      --app-menu-text: #e2e8f0;
      --app-menu-border: rgba(148, 163, 184, 0.35);
      --app-menu-item-bg: rgba(255, 255, 255, 0.04);
      --app-menu-item-border: rgba(255, 255, 255, 0.08);
      --app-menu-item-text: #f8fafc;
      --app-menu-item-hover-bg: rgba(16, 185, 129, 0.16);
      --app-menu-item-hover-border: rgba(16, 185, 129, 0.45);
      --app-menu-item-hover-text: #befae0;
      --app-sheet-bg: #ffffff;
      --app-sheet-text: #0f172a;
      --app-sheet-border: rgba(148, 163, 184, 0.22);
      --app-sheet-shadow: 0 -18px 45px rgba(15, 23, 42, 0.18);
      --app-sheet-backdrop: rgba(15, 23, 42, 0.35);
      --app-sheet-handle: rgba(15, 23, 42, 0.18);
      --app-sheet-title: #0f172a;
      --app-sheet-subtitle: #64748b;
      --app-sheet-close: #334155;
      --app-sheet-close-hover: #047857;
      --app-sheet-item-bg: #ffffff;
      --app-sheet-item-text: #0f172a;
      --app-sheet-item-border: rgba(148, 163, 184, 0.28);
      --app-sheet-item-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
      --app-sheet-item-hover-border: rgba(16, 185, 129, 0.55);
      --app-sheet-item-hover-shadow: 0 12px 28px rgba(16, 185, 129, 0.12);
      --app-sheet-icon-bg: rgba(15, 23, 42, 0.06);
      --app-sheet-icon-text: #0f172a;
      --app-negative-text: #dc2626;
      --app-highlight-symbol: #fde047;
      --app-market-pill-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7), 0 15px 35px rgba(15, 23, 42, 0.08);
      --app-market-icon-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 8px 18px rgba(15, 23, 42, 0.12);
      --app-meta-tile-shadow: 0 10px 25px rgba(15, 23, 42, 0.2);
      --app-on-accent-text: #ffffff;
      --app-meta-text: #ffffff;
      --app-meta-subtext: rgba(255, 255, 255, 0.85);
      --app-success-border: #059669;
      --app-success-ring: rgba(16, 185, 129, 0.18);
      --app-on-success-text: #ffffff;
      --app-order-ref-default: #334155;
      --app-order-ref-buy: #047857;
      --app-order-ref-sell: #b91c1c;
      --app-order-accent-emerald: #10b981;
      --app-order-accent-sky: #0ea5e9;
      --app-order-accent-amber: #f59e0b;
      --app-order-accent-purple: #a855f7;
      --app-order-accent-rose: #f43f5e;
      --app-order-accent-indigo: #6366f1;
      --app-level-action-sell-text: #b91c1c;
      --app-level-action-sell-bg: rgba(248, 113, 113, 0.16);
      --app-level-action-buy-text: #047857;
      --app-level-action-buy-bg: rgba(16, 185, 129, 0.16);
      --app-level-action-grid-text: #0f172a;
      --app-level-action-grid-bg: rgba(15, 23, 42, 0.07);
      --app-level-action-split-text: #1d4ed8;
      --app-level-action-split-bg: rgba(59, 130, 246, 0.16);
      --app-badge-emerald-bg: #d1fae5;
      --app-badge-emerald-text: #047857;
      --app-badge-sky-bg: #e0f2fe;
      --app-badge-sky-text: #0369a1;
      --app-badge-amber-bg: #fef3c7;
      --app-badge-amber-border: #fcd34d;
      --app-badge-amber-text: #b45309;
      --app-badge-purple-bg: #f3e8ff;
      --app-badge-purple-text: #6b21a8;
      --app-badge-rose-bg: #ffe4e6;
      --app-badge-rose-text: #be123c;
      --app-badge-indigo-bg: #e0e7ff;
      --app-badge-indigo-text: #4338ca;
      --app-timeline-bg: linear-gradient(135deg, #f8fbff, #f1f5f9);
      --app-timeline-border: #e2e8f0;
      --app-timeline-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      --app-timeline-chip-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.05), 0 8px 18px rgba(15, 23, 42, 0.06);
      --app-timeline-chip-icon-bg: rgba(255, 255, 255, 0.42);
      --app-timeline-chip-icon-border: rgba(255, 255, 255, 0.28);
      --app-timeline-chip-time: rgba(15, 23, 42, 0.8);
      --app-timeline-axis-text: #475569;
      --app-timeline-axis-strong: #0f172a;
      --app-timeline-axis-line: rgba(148, 163, 184, 0.35);
      --app-timeline-axis-tick: rgba(148, 163, 184, 0.7);
      --app-timeline-now: #fbbf24;
      --app-timeline-now-ring: rgba(251, 191, 36, 0.25);
      --app-timeline-now-glow-start: rgba(251, 191, 36, 0.16);
      --app-timeline-now-glow-end: rgba(251, 191, 36, 0.08);
      --app-live-panel-bg: transparent;
      --app-live-panel-border: #e2e8f0;
      --session-overnight-bg: #e2e8f0;
      --session-overnight-text: #0f172a;
      --session-premarket-bg: #fcd34d;
      --session-premarket-text: #92400e;
      --session-market-bg: rgba(34, 197, 94, 0.85);
      --session-market-text: #064e3b;
      --session-afterhours-bg: #7c9cf5;
      --session-afterhours-text: #1e3a8a;
    }

    html[data-theme="dark"] {
      color-scheme: dark;
      --app-bg: #0b1120;
      --app-surface: #111827;
      --app-surface-muted: #0f172a;
      --app-surface-strong: #1f2937;
      --app-border: #1f2937;
      --app-border-muted: rgba(148, 163, 184, 0.2);
      --app-text: #f8fafc;
      --app-text-muted: #cbd5e1;
      --app-text-subtle: #94a3b8;
      --app-header-bg: rgba(15, 23, 42, 0.92);
      --app-header-border: #1f2937;
      --app-sidebar-bg: #0f172a;
      --app-tabbar-bg: #0f172a;
      --app-shadow-soft: 0 25px 45px rgba(0, 0, 0, 0.35);
      --app-shadow-elevated: 0 16px 32px rgba(0, 0, 0, 0.45);
      --app-log-bg: #0b1221;
      --app-log-border: rgba(148, 163, 184, 0.25);
      --app-chart-card-bg: #111827;
      --app-chart-card-border: rgba(31, 41, 55, 0.9);
      --app-chart-stat-bg: rgba(15, 23, 42, 0.9);
      --app-chart-stat-border: rgba(31, 41, 55, 0.9);
      --app-chart-dot: rgba(148, 163, 184, 0.55);
      --app-chart-dot-hover: rgba(148, 163, 184, 0.8);
      --app-chart-overlay-bg: rgba(15, 23, 42, 0.72);
      --app-chart-key-harvest: rgba(52, 211, 153, 0.95);
      --app-chart-key-cash: rgba(167, 139, 250, 0.95);
      --app-chart-axis-text: #94a3b8;
      --app-chart-grid: rgba(148, 163, 184, 0.2);
      --app-chart-legend-text: #e2e8f0;
      --app-chart-cash-line: rgba(167, 139, 250, 0.95);
      --app-chart-cash-fill: rgba(167, 139, 250, 0.2);
      --app-chart-harvest-line: rgba(52, 211, 153, 0.95);
      --app-chart-harvest-fill: rgba(52, 211, 153, 0.2);
      --app-overlay-bg: rgba(2, 6, 23, 0.7);
      --app-overlay-text: #e2e8f0;
      --app-badge-warning-bg: rgba(251, 146, 60, 0.2);
      --app-badge-warning-border: rgba(251, 146, 60, 0.45);
      --app-badge-warning-text: #fdba74;
      --app-badge-neutral-bg: rgba(148, 163, 184, 0.2);
      --app-badge-info-hover: rgba(59, 130, 246, 0.2);
      --app-badge-info-bg: rgba(59, 130, 246, 0.22);
      --app-badge-info-border: rgba(59, 130, 246, 0.85);
      --app-badge-info-ring: rgba(59, 130, 246, 0.35);
      --app-badge-info-text: #bfdbfe;
      --app-badge-success-hover: rgba(16, 185, 129, 0.2);
      --app-badge-success-bg: rgba(16, 185, 129, 0.24);
      --app-badge-success-border: rgba(16, 185, 129, 0.7);
      --app-badge-success-ring: rgba(16, 185, 129, 0.35);
      --app-badge-success-text: #bbf7d0;
      --app-live-badge-on-bg: #10b981;
      --app-live-badge-on-text: #ecfdf5;
      --app-live-badge-off-bg: #1f2937;
      --app-live-badge-off-text: #94a3b8;
      --app-live-badge-off-border: #334155;
      --app-alert-warning-bg: rgba(180, 83, 9, 0.2);
      --app-alert-warning-border: rgba(251, 191, 36, 0.4);
      --app-alert-warning-text: #fcd34d;
      --app-status-inactive-bg: #334155;
      --app-status-idle-bg: #475569;
      --app-status-armed-bg: #22c55edd;
      --app-status-waiting-bg: #f59e0b;
      --app-status-orphan-bg: #8b5cf6;
      --app-card-buy-bg: #14532d;
      --app-card-buy-border: #22c55e;
      --app-card-sell-bg: #4c0519;
      --app-card-sell-border: #f43f5e;
      --app-split-buy-bg: #065f46;
      --app-split-sell-bg: #b45309;
      --app-market-open-bg: linear-gradient(135deg, #064e3b, #0f766e);
      --app-market-open-border: #34d399;
      --app-market-open-text: #d1fae5;
      --app-market-open-shadow: 0 15px 35px rgba(16, 185, 129, 0.35);
      --app-market-open-icon-bg: #065f46;
      --app-market-open-icon-text: #a7f3d0;
      --app-market-closed-bg: linear-gradient(135deg, #7f1d1d, #991b1b);
      --app-market-closed-border: #f87171;
      --app-market-closed-text: #fee2e2;
      --app-market-closed-shadow: 0 15px 35px rgba(248, 113, 113, 0.3);
      --app-market-closed-icon-bg: #7f1d1d;
      --app-market-closed-icon-text: #fecaca;
      --app-market-guard-bg: linear-gradient(135deg, #78350f, #92400e);
      --app-market-guard-border: #fbbf24;
      --app-market-guard-text: #fef3c7;
      --app-market-guard-shadow: 0 15px 35px rgba(250, 204, 21, 0.25);
      --app-market-guard-icon-bg: #78350f;
      --app-market-guard-icon-text: #fde68a;
      --app-pill-neutral-bg: linear-gradient(135deg, #1f2937, #111827);
      --app-pill-neutral-border: #334155;
      --app-pill-neutral-text: #e2e8f0;
      --app-pill-buy-bg: linear-gradient(135deg, #059669, #34d399);
      --app-pill-buy-border: #10b981;
      --app-pill-buy-text: #ecfdf3;
      --app-pill-sell-bg: linear-gradient(135deg, #be123c, #f43f5e);
      --app-pill-sell-border: #f43f5e;
      --app-pill-sell-text: #ffe4e6;
      --app-accent: #60a5fa;
      --app-accent-strong: #3b82f6;
      --app-scrollbar-thumb: rgba(148, 163, 184, 0.45);
      --app-sort-indicator: #475569;
      --app-spinner-border: rgba(148, 163, 184, 0.35);
      --app-tooltip-bg: #0b1221;
      --app-tooltip-text: #f8fafc;
      --app-tooltip-shadow: 0 20px 45px rgba(0, 0, 0, 0.5);
      --app-tooltip-button-bg: #111827;
      --app-tooltip-button-border: rgba(148, 163, 184, 0.2);
      --app-tooltip-button-text: #e2e8f0;
      --app-tooltip-button-hover-bg: #1e293b;
      --app-tooltip-button-hover-border: rgba(16, 185, 129, 0.5);
      --app-tooltip-button-ring: rgba(52, 211, 153, 0.45);
      --app-tooltip-button-success-bg: #059669;
      --app-tooltip-button-success-border: #059669;
      --app-tooltip-button-success-text: #ecfdf3;
      --app-tooltip-close-bg: rgba(15, 23, 42, 0.7);
      --app-tooltip-close-hover-bg: rgba(15, 23, 42, 0.95);
      --app-tooltip-close-text: #cbd5f5;
      --app-tooltip-close-hover-text: #ffffff;
      --app-tooltip-code-bg: rgba(148, 163, 184, 0.15);
      --app-tooltip-code-border: rgba(148, 163, 184, 0.25);
      --app-focus-ring: rgba(16, 185, 129, 0.45);
      --app-segment-active-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      --app-pull-bg: rgba(15, 23, 42, 0.85);
      --app-pull-border: rgba(148, 163, 184, 0.35);
      --app-pull-text: #cbd5e1;
      --app-pull-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
      --app-border-strong: #334155;
      --app-row-hover-bg: rgba(16, 185, 129, 0.16);
      --app-row-selected-bg: rgba(16, 185, 129, 0.24);
      --app-row-selected-ring: rgba(16, 185, 129, 0.45);
      --app-checkbox-border: #64748b;
      --app-checkbox-bg: #0f172a;
      --app-checkbox-indeterminate-bg: #1f2937;
      --app-checkbox-indeterminate-border: #64748b;
      --app-checkbox-indeterminate-icon: #94a3b8;
      --app-level-metric-bg: rgba(15, 23, 42, 0.9);
      --app-level-metric-border: rgba(31, 41, 55, 0.9);
      --app-level-metric-label: rgba(148, 163, 184, 0.9);
      --app-level-bar-bg: #0f172a;
      --app-level-bar-border: rgba(148, 163, 184, 0.18);
      --app-level-bar-divider: rgba(148, 163, 184, 0.35);
      --app-level-marker: rgba(148, 163, 184, 0.4);
      --app-level-price-label: #e2e8f0;
      --app-level-price-dot: #22c55e;
      --app-level-price-dot-border: #ecfeff;
      --app-level-price-dot-shadow: 0 2px 6px rgba(34, 197, 94, 0.3);
      --app-menu-bg: #0b1221;
      --app-menu-text: #e2e8f0;
      --app-menu-border: rgba(148, 163, 184, 0.25);
      --app-menu-item-bg: rgba(148, 163, 184, 0.08);
      --app-menu-item-border: rgba(148, 163, 184, 0.18);
      --app-menu-item-text: #e2e8f0;
      --app-menu-item-hover-bg: rgba(16, 185, 129, 0.2);
      --app-menu-item-hover-border: rgba(16, 185, 129, 0.5);
      --app-menu-item-hover-text: #bbf7d0;
      --app-sheet-bg: #0f172a;
      --app-sheet-text: #e2e8f0;
      --app-sheet-border: rgba(148, 163, 184, 0.2);
      --app-sheet-shadow: 0 -18px 45px rgba(0, 0, 0, 0.5);
      --app-sheet-backdrop: rgba(2, 6, 23, 0.6);
      --app-sheet-handle: rgba(148, 163, 184, 0.35);
      --app-sheet-title: #f8fafc;
      --app-sheet-subtitle: #94a3b8;
      --app-sheet-close: #cbd5e1;
      --app-sheet-close-hover: #34d399;
      --app-sheet-item-bg: #111827;
      --app-sheet-item-text: #e2e8f0;
      --app-sheet-item-border: rgba(148, 163, 184, 0.22);
      --app-sheet-item-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      --app-sheet-item-hover-border: rgba(52, 211, 153, 0.6);
      --app-sheet-item-hover-shadow: 0 12px 28px rgba(16, 185, 129, 0.2);
      --app-sheet-icon-bg: rgba(148, 163, 184, 0.15);
      --app-sheet-icon-text: #e2e8f0;
      --app-negative-text: #f87171;
      --app-highlight-symbol: #fcd34d;
      --app-market-pill-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.6), 0 15px 35px rgba(0, 0, 0, 0.35);
      --app-market-icon-shadow: inset 0 1px 0 rgba(15, 23, 42, 0.4), 0 8px 18px rgba(0, 0, 0, 0.4);
      --app-meta-tile-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
      --app-on-accent-text: #ffffff;
      --app-meta-text: #ffffff;
      --app-meta-subtext: rgba(255, 255, 255, 0.85);
      --app-success-border: #10b981;
      --app-success-ring: rgba(16, 185, 129, 0.25);
      --app-on-success-text: #ffffff;
      --app-order-ref-default: #cbd5e1;
      --app-order-ref-buy: #34d399;
      --app-order-ref-sell: #f87171;
      --app-order-accent-emerald: #34d399;
      --app-order-accent-sky: #38bdf8;
      --app-order-accent-amber: #fbbf24;
      --app-order-accent-purple: #c084fc;
      --app-order-accent-rose: #fb7185;
      --app-order-accent-indigo: #818cf8;
      --app-level-action-sell-text: #f87171;
      --app-level-action-sell-bg: rgba(248, 113, 113, 0.2);
      --app-level-action-buy-text: #34d399;
      --app-level-action-buy-bg: rgba(16, 185, 129, 0.2);
      --app-level-action-grid-text: #e2e8f0;
      --app-level-action-grid-bg: rgba(148, 163, 184, 0.15);
      --app-level-action-split-text: #93c5fd;
      --app-level-action-split-bg: rgba(59, 130, 246, 0.2);
      --app-badge-emerald-bg: rgba(16, 185, 129, 0.2);
      --app-badge-emerald-text: #6ee7b7;
      --app-badge-sky-bg: rgba(56, 189, 248, 0.2);
      --app-badge-sky-text: #7dd3fc;
      --app-badge-amber-bg: rgba(251, 191, 36, 0.2);
      --app-badge-amber-border: rgba(251, 191, 36, 0.45);
      --app-badge-amber-text: #fcd34d;
      --app-badge-purple-bg: rgba(192, 132, 252, 0.2);
      --app-badge-purple-text: #e9d5ff;
      --app-badge-rose-bg: rgba(251, 113, 133, 0.2);
      --app-badge-rose-text: #fda4af;
      --app-badge-indigo-bg: rgba(129, 140, 248, 0.2);
      --app-badge-indigo-text: #c7d2fe;
      --app-timeline-bg: linear-gradient(135deg, #0f172a, #111827);
      --app-timeline-border: #1f2937;
      --app-timeline-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
      --app-timeline-chip-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.4), 0 8px 18px rgba(0, 0, 0, 0.4);
      --app-timeline-chip-icon-bg: rgba(15, 23, 42, 0.35);
      --app-timeline-chip-icon-border: rgba(148, 163, 184, 0.25);
      --app-timeline-chip-time: rgba(226, 232, 240, 0.8);
      --app-timeline-axis-text: #94a3b8;
      --app-timeline-axis-strong: #e2e8f0;
      --app-timeline-axis-line: rgba(148, 163, 184, 0.2);
      --app-timeline-axis-tick: rgba(148, 163, 184, 0.45);
      --app-timeline-now: #fbbf24;
      --app-timeline-now-ring: rgba(251, 191, 36, 0.35);
      --app-timeline-now-glow-start: rgba(251, 191, 36, 0.2);
      --app-timeline-now-glow-end: rgba(251, 191, 36, 0.1);
      --app-live-panel-bg: transparent;
      --app-live-panel-border: var(--app-border);
      --session-overnight-bg: #1f2937;
      --session-overnight-text: #e2e8f0;
      --session-premarket-bg: #f59e0b;
      --session-premarket-text: #1f2937;
      --session-market-bg: rgba(34, 197, 94, 0.35);
      --session-market-text: #bbf7d0;
      --session-afterhours-bg: #3b82f6;
      --session-afterhours-text: #eff6ff;
    }

    html,
    body {
      background: var(--app-bg);
      color: var(--app-text);
    }
    .bg-white {
      background-color: var(--app-surface) !important;
    }
    .bg-slate-50 {
      background-color: var(--app-bg) !important;
    }
    .bg-slate-100 {
      background-color: var(--app-surface-muted) !important;
    }
    .bg-slate-200 {
      background-color: var(--app-surface-strong) !important;
    }
    .text-slate-500 {
      color: var(--app-text-subtle) !important;
    }
    .text-slate-600,
    .text-slate-700 {
      color: var(--app-text-muted) !important;
    }
    .text-slate-800,
    .text-slate-900 {
      color: var(--app-text) !important;
    }
    .border-slate-100 {
      border-color: var(--app-border-muted) !important;
    }
    .border-slate-200 {
      border-color: var(--app-border) !important;
    }
    .border-slate-300 {
      border-color: var(--app-border-strong) !important;
    }
    .hover\\:bg-slate-50:hover {
      background-color: var(--app-row-hover-bg) !important;
    }
    .hover\\:bg-slate-100:hover {
      background-color: var(--app-surface-muted) !important;
    }
    .bg-emerald-50 {
      background-color: var(--app-row-selected-bg) !important;
    }
    .shadow-soft {
      box-shadow: var(--app-shadow-soft);
    }
    .sticky-th {
      background: var(--app-surface);
    }
    thead th {
      background: var(--app-surface);
    }
    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea {
      background-color: var(--app-surface);
      color: var(--app-text);
      border-color: var(--app-border);
    }
    input::placeholder,
    textarea::placeholder {
      color: var(--app-text-subtle);
    }
    .table-row:hover {
      background-color: var(--app-row-hover-bg) !important;
    }
    .table-row.table-row-selected {
      background-color: var(--app-row-selected-bg) !important;
      box-shadow: inset 0 0 0 1px var(--app-row-selected-ring);
    }
    #gridLadderContainer table,
    #gridLadderContainer thead tr,
    #breakeven-matrix-table table,
    #breakeven-matrix-table thead tr {
      border-color: var(--app-border-muted);
    }
    #gridLadderContainer thead,
    #breakeven-matrix-table thead {
      background-color: var(--app-surface-muted);
      color: var(--app-text-subtle);
    }
    #gridLadderContainer thead th,
    #breakeven-matrix-table thead th {
      color: var(--app-text-subtle);
    }
    #gridLadderContainer tbody td:not(.num-pos):not(.num-neg):not(.text-emerald-700) {
      color: var(--app-text-muted);
    }
    #breakeven-matrix-table tbody td:not(.text-emerald-700):not(.text-yellow-700):not(.text-orange-700):not(.text-red-700) {
      color: var(--app-text-muted);
    }
    #gridLadderContainer .divide-slate-100 > :not([hidden]) ~ :not([hidden]),
    #gridLadderContainer .divide-slate-200 > :not([hidden]) ~ :not([hidden]),
    #breakeven-matrix-table .divide-slate-100 > :not([hidden]) ~ :not([hidden]),
    #breakeven-matrix-table .divide-slate-200 > :not([hidden]) ~ :not([hidden]) {
      border-color: var(--app-border-muted);
    }
    .num-pos { color: #119d6e !important; }
    .num-neg { color: #ff0000 !important; }
    .pnl-strong { font-size: 1.8rem !important; }
    .sticky-th { position: sticky; top: 0; background: var(--app-surface); z-index: 1; }
    .shadow-soft { box-shadow: var(--app-shadow-soft); }
    thead th { position: sticky; top: 0; background: var(--app-surface); z-index: 1; }

    /* Hide native spin buttons for key numeric inputs */
    #inp_orb_m::-webkit-outer-spin-button,
    #inp_orb_m::-webkit-inner-spin-button,
    #inp_target_R::-webkit-outer-spin-button,
    #inp_target_R::-webkit-inner-spin-button,
    #inp_stop_R::-webkit-outer-spin-button,
    #inp_stop_R::-webkit-inner-spin-button,
    #inp_risk_pct::-webkit-outer-spin-button,
    #inp_risk_pct::-webkit-inner-spin-button,
    #inp_aum0::-webkit-outer-spin-button,
    #inp_aum0::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #inp_orb_m,
    #inp_target_R,
    #inp_stop_R,
    #inp_risk_pct,
    #inp_aum0 {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Generic: hide spinners for any future number input */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* Session controls responsive layout */
    #sessionSegment {
      display: flex;
      flex-wrap: wrap;
      max-width: 100%;
      min-width: 0;
      white-space: normal;
    }
    #sessionSegment button {
      flex: 0 0 auto;
    }

    .details-icon summary::-webkit-details-marker {
      display: none;
    }
    .details-icon summary::marker {
      content: '';
    }
    nav a[data-nav].bg-slate-800 {
      color: #ffffff !important;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Site navigation -->
  <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-6 py-3 flex items-center gap-4">
      <div class="flex items-center gap-6 flex-1 min-w-0">
        <div class="flex items-center gap-2 font-semibold text-slate-800">
          <svg class="h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" aria-hidden="true"><path d="M192 384L88.5 384C63.6 384 48.3 356.9 61.1 335.5L114 247.3C122.7 232.8 138.3 224 155.2 224L250.2 224C326.3 95.1 439.8 88.6 515.7 99.7C528.5 101.6 538.5 111.6 540.3 124.3C551.4 200.2 544.9 313.7 416 389.8L416 484.8C416 501.7 407.2 517.3 392.7 526L304.5 578.9C283.2 591.7 256 576.3 256 551.5L256 448C256 412.7 227.3 384 192 384L191.9 384zM464 224C464 197.5 442.5 176 416 176C389.5 176 368 197.5 368 224C368 250.5 389.5 272 416 272C442.5 272 464 250.5 464 224z"/></svg>
          <span>GRID</span>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <a data-nav href="grid.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Grid Backtest</a>
          <a data-nav href="grid_calc.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">Grid Calculator</a>
          <a data-nav href="grid_about.html" class="px-3 py-1.5 rounded-lg text-sm text-slate-700 hover:bg-slate-100">About</a>
        </div>
      </div>
      <label class="inline-flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
        <span>Dark mode</span>
        <span class="relative inline-flex h-5 w-9 items-center">
          <input id="toggleTheme" type="checkbox" class="peer sr-only">
          <span class="absolute inset-0 rounded-full bg-slate-200 transition peer-checked:bg-emerald-500"></span>
          <span class="absolute left-0.5 h-4 w-4 rounded-full bg-white shadow-sm transition peer-checked:translate-x-4"></span>
        </span>
      </label>
    </div>
  </nav>
  <script>
    // Activate nav item for current page
    (function(){
      try {
        const file = (location.pathname.split('/').pop() || 'grid.html').toLowerCase();
        document.querySelectorAll('a[data-nav]').forEach(a => {
          const href = (a.getAttribute('href') || '').toLowerCase();
          const active = href === file || (file === '' && href.endsWith('index.html'));
          a.classList.toggle('bg-slate-800', active);
          a.classList.toggle('text-white', active);
          if (active) {
            a.classList.remove('text-slate-700');
          } else {
            a.classList.add('text-slate-700');
          }
          a.classList.toggle('hover:bg-slate-100', !active);
          if (active) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
        });
      } catch {}
    })();
  </script>

  <div class="max-w-screen-2xl mx-auto p-6 space-y-6">
    <header class="mb-2">
      <h1 id="mainTitle" class="text-2xl md:text-3xl font-semibold">Grid Calculator</h1>
    </header>

    <section id="gridTabsNav" class="bg-white rounded-2xl shadow-soft p-3 md:p-4">
      <div class="overflow-x-auto -mx-3 md:mx-0 px-3 md:px-0">
        <nav class="flex min-w-max border-b border-slate-200 gap-1" role="tablist" aria-label="Grid utilities">
          <button
            type="button"
            id="tab-btn-grid-calculator"
            data-tab-button="grid-calculator"
            aria-controls="grid-calculator-tab"
            role="tab"
            aria-selected="true"
            class="inline-flex items-center gap-2 border-b-2 border-emerald-500 px-3 py-2 text-sm font-medium text-slate-900 transition"
          >
            <span class="inline-flex h-8 w-8 items-center justify-center text-emerald-500">
              <ion-icon name="grid-outline" class="text-2xl"></ion-icon>
            </span>
            <span>Grid Calculator</span>
          </button>
          <button
            type="button"
            id="tab-btn-breakeven-matrix"
            data-tab-button="breakeven-matrix"
            aria-controls="breakeven-matrix-tab"
            role="tab"
            aria-selected="false"
            class="inline-flex items-center gap-2 border-b-2 border-transparent px-3 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 transition"
          >
            <span class="inline-flex h-8 w-8 items-center justify-center text-emerald-500">
              <ion-icon name="stats-chart-outline" class="text-2xl"></ion-icon>
            </span>
            <span>Breakeven Matrix</span>
          </button>
        </nav>
      </div>
    </section>

    <div
      id="grid-calculator-tab"
      data-tab-panel="grid-calculator"
      role="tabpanel"
      aria-labelledby="tab-btn-grid-calculator"
      class="space-y-6"
      tabindex="0"
    >
    <section id="gridParameters" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div class="flex flex-col gap-1">
          <h2 class="font-semibold text-slate-700">Grid Parameters</h2>
          <p class="text-sm text-slate-500">Adjust the inputs below to preview ladder levels around the starting price.</p>
        </div>
        <label class="inline-flex items-center gap-2 text-xs text-slate-500 cursor-pointer">
          <span>Explain</span>
          <span class="relative inline-flex h-5 w-9 items-center">
            <input id="toggleExplain" type="checkbox" class="peer sr-only">
            <span class="absolute inset-0 rounded-full bg-slate-200 transition peer-checked:bg-emerald-500"></span>
            <span class="absolute left-0.5 h-4 w-4 rounded-full bg-white shadow-sm transition peer-checked:translate-x-4"></span>
          </span>
        </label>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-8 gap-4">
        <label class="block">
          <span class="text-sm text-slate-600">Start Price ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpStartPrice"
              type="number"
              step="0.01"
              min="0"
              value="100"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase start price" data-num-target="inpStartPrice" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease start price" data-num-target="inpStartPrice" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Start Shares</span>
          <div class="mt-1 relative">
            <input
              id="inpShares"
              type="number"
              min="0"
              step="50"
              value="0"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase shares" data-num-target="inpShares" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease shares" data-num-target="inpShares" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Tick Size</span>
          <div class="relative mt-1">
            <select
              id="selTickSize"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="1">1</option>
              <option value="0.1">0.1</option>
              <option value="0.01" selected>0.01</option>
              <option value="0.005">0.005</option>
              <option value="0.001">0.001</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Grid Spacing</span>
          <div class="relative mt-1">
            <select
              id="selGridSpacing"
              class="w-full appearance-none rounded-xl border border-slate-200 bg-white pl-3 pr-9 py-2 text-sm text-slate-700 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <option value="fixed">Fixed Price</option>
              <option value="percent" selected>Percentage</option>
            </select>
            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.06 1.06l-4.24 4.39a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
              </svg>
            </span>
          </div>
        </label>
        <label class="block">
          <span id="gridSizeLabel" class="text-sm text-slate-600">Grid Size ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpGridSize"
              type="number"
              step="0.5"
              min="0.5"
              value="5"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase grid size" data-num-target="inpGridSize" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease grid size" data-num-target="inpGridSize" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Levels Down</span>
          <div class="mt-1 relative">
            <input
              id="inpLevelCount"
              type="number"
              min="1"
              max="100"
              step="1"
              value="20"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase levels down" data-num-target="inpLevelCount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease levels down" data-num-target="inpLevelCount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Levels Up</span>
          <div class="mt-1 relative">
            <input
              id="inpLevelCountUp"
              type="number"
              min="0"
              max="100"
              step="1"
              value="10"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase levels up" data-num-target="inpLevelCountUp" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease levels up" data-num-target="inpLevelCountUp" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
        <label class="block">
          <span class="text-sm text-slate-600">Trade Amount ($)</span>
          <div class="mt-1 relative">
            <input
              id="inpTradeAmount"
              type="number"
              min="0"
              step="50"
              value="1000"
              class="w-full border border-slate-200 bg-white text-slate-700 shadow-sm rounded-xl pl-3 pr-10 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            />
            <div class="absolute inset-y-0 right-1 flex flex-col justify-center py-1">
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Increase trade amount" data-num-target="inpTradeAmount" data-num-step="1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 12.79a.75.75 0 001.06-.02L10 9.06l3.71 3.71a.75.75 0 001.06-1.06l-4.24-4.24a.75.75 0 00-1.06 0l-4.24 4.24a.75.75 0 00.02 1.08z" clip-rule="evenodd" /></svg>
              </button>
              <button type="button" class="h-4 w-6 text-slate-500 hover:text-slate-700" aria-label="Decrease trade amount" data-num-target="inpTradeAmount" data-num-step="-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.77 7.21a.75.75 0 00-1.06.02L10 10.94 6.29 7.23a.75.75 0 10-1.06 1.06l4.24 4.24a.75.75 0 001.06 0l4.24-4.24a.75.75 0 00-.02-1.08z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
        </label>
      </div>
    </section>

    <section id="gridCarousel" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3" aria-roledescription="carousel" aria-label="Grid chart views">
      <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white">
        <div data-carousel-track class="flex w-full transition-transform duration-300 ease-out">
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridOverviewChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart compares the buy-and-hold market value against grid equity (cash extracted plus remaining shares) at each grid level. While buy-and-hold fully captures the asset's price movement, the grid progressively converts inventory to cash on the way up, changing the equity profile across levels.
                </div>
              </details>
            </div>
          </div>
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridPlChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart shows the realised profit and loss of the grid strategy at each level, assuming no oscillation beyond the displayed range. Profits accumulate gradually on the way up through harvested trades, while losses increase more slowly on the way down compared to buy-and-hold. The curve illustrates how grid strategies rely on price oscillation rather than directional forecasting.
                </div>
              </details>
            </div>
          </div>
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridCashflowChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart shows cumulative net cashflow as price moves through grid levels. Downside levels reflect incremental capital committed through grid buys, while upside levels reflect cash returned through grid sells. Net cashflow captures trading activity rather than risk exposure and illustrates how the grid gradually converts price movement into realised cash over time.
                </div>
              </details>
            </div>
          </div>
          <div class="min-w-full p-3 md:p-4">
            <div class="space-y-4">
              <div class="relative h-80 md:h-96 rounded-xl border border-slate-200 bg-white p-3">
                <button type="button" class="absolute right-3 top-3 p-0 text-slate-400 transition hover:text-emerald-600 focus:outline-none" aria-label="Show chart notes" data-chart-info-toggle>
                  <ion-icon name="information-circle-outline" class="text-sm"></ion-icon>
                </button>
                <canvas id="gridSharesChart" class="h-full w-full"></canvas>
              </div>
              <details class="details-icon w-full" data-chart-info>
                <summary class="sr-only">Chart notes</summary>
                <div class="rounded-xl border border-slate-200 bg-slate-50/70 px-4 py-3 text-sm text-slate-600">
                  This chart tracks shares held across grid levels. Watch for flat or slowly rising lines as price moves lower; an asymptote suggests the grid keeps adding smaller increments and may behave like an infinite grid if spacing and trade size remain unchanged.
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>
      <div class="flex items-center justify-center gap-2">
        <button type="button" data-carousel-dot="0" class="h-2.5 w-2.5 rounded-full bg-emerald-500" aria-label="Show view 1" aria-current="true"></button>
        <button type="button" data-carousel-dot="1" class="h-2.5 w-2.5 rounded-full bg-slate-300" aria-label="Show view 2"></button>
        <button type="button" data-carousel-dot="2" class="h-2.5 w-2.5 rounded-full bg-slate-300" aria-label="Show view 3"></button>
        <button type="button" data-carousel-dot="3" class="h-2.5 w-2.5 rounded-full bg-slate-300" aria-label="Show view 4"></button>
      </div>
    </section>
    <section id="gridExplainPanel" class="hidden bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <h3 class="text-sm font-semibold text-slate-700">Explanation</h3>
        <div id="gridExplainSegment" class="inline-flex rounded-full border border-slate-200 bg-slate-100 p-1 text-xs font-semibold text-slate-600">
          <button type="button" data-explain-view="brief" class="px-3 py-1 rounded-full">Brief</button>
          <button type="button" data-explain-view="compact" class="px-3 py-1 rounded-full">Compact</button>
          <button type="button" data-explain-view="verbose" class="px-3 py-1 rounded-full">Verbose</button>
        </div>
      </div>
      <div class="rounded-xl border border-slate-200 bg-white p-4 space-y-2">
        <div id="gridExplainBrief" class="text-sm text-slate-600 leading-relaxed space-y-4"></div>
        <div id="gridExplainCompact" class="text-sm text-slate-600 leading-relaxed space-y-4 hidden"></div>
        <div id="gridExplainVerbose" class="text-sm text-slate-600 leading-relaxed space-y-4 hidden"></div>
      </div>
    </section>

    <section id="gridLadderSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex flex-col gap-1">
        <h2 class="font-semibold text-slate-700">Grid Ladder Preview</h2>
        <p id="gridLadderSummary" class="text-sm text-slate-500">Adjust the grid parameters to preview ladder levels around the starting price.</p>
      </div>
      <div class="overflow-x-auto">
        <div id="gridLadderContainer" class="min-w-full rounded-xl border border-slate-200 bg-white">
          <div class="p-4 text-sm text-slate-500">Enter a valid starting price, grid size, and levels down to draw the ladder.</div>
        </div>
      </div>
    </section>

      <section id="gridJsonSection" class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-3">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h2 class="font-semibold text-slate-700">Grid JSON Export</h2>
          <p class="text-sm text-slate-500">Copy the current ladder as JSON for scripting or sharing.</p>
        </div>
      </div>
      <div class="relative">
        <button
          type="button"
          id="btnCopyGridJson"
          class="absolute right-3 top-3 inline-flex items-center gap-2 rounded-lg border border-slate-600/30 bg-slate-800/80 px-3 py-1 text-xs font-medium text-white transition hover:bg-slate-700 disabled:cursor-not-allowed disabled:bg-slate-700/50"
          disabled
        >
          <ion-icon name="copy-outline" class="text-base"></ion-icon>
          <span data-copy-label>Copy JSON</span>
        </button>
        <pre class="bg-slate-900 text-slate-100 rounded-2xl p-4 text-xs md:text-sm font-mono overflow-x-auto shadow-inner min-h-[140px]">
<code id="gridJsonCode">// Adjust grid inputs above to generate JSON.</code>
        </pre>
      </div>
      </section>
    </div>

    <div
      id="breakeven-matrix-tab"
      data-tab-panel="breakeven-matrix"
      role="tabpanel"
      aria-labelledby="tab-btn-breakeven-matrix"
      class="space-y-6 hidden"
      hidden
      tabindex="0"
    >
      <section class="bg-white rounded-2xl shadow-soft p-3 md:p-4 space-y-4">
        <div class="flex flex-col gap-1">
          <h2 class="font-semibold text-slate-700">Breakeven Matrix</h2>
          <p class="text-sm text-slate-500">Explore how many take-profit fills are required to offset layered buys at each grid depth.</p>
        </div>
        <form id="breakevenMatrixForm" class="space-y-4">
          <div class="grid gap-4 md:grid-cols-3">
            <label class="block">
              <span class="text-sm text-slate-600">Max Levels</span>
              <input
                id="inpBreakevenLevels"
                type="number"
                min="10"
                max="200"
                value="50"
                data-default="50"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
              />
              <span class="mt-1 block text-xs text-slate-500">Display 1 through this level count.</span>
            </label>
            <label class="block md:col-span-2">
              <span class="text-sm text-slate-600">TP% List</span>
              <input
                id="inpBreakevenTpList"
                type="text"
                value="1, 2, 2.5, 3, 4, 5"
                data-default="1, 2, 2.5, 3, 4, 5"
                class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                placeholder="Example: 0.5, 1, 1.5, 2"
              />
              <span class="mt-1 block text-xs text-slate-500">Separate values with commas. Each TP% creates a column.</span>
            </label>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button
              type="submit"
              id="btnGenerateBreakeven"
              class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
            >
              <ion-icon name="refresh-outline" class="text-base"></ion-icon>
              <span>Generate Matrix</span>
            </button>
            <button
              type="button"
              id="btnResetBreakeven"
              class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-emerald-500/30"
            >
              <ion-icon name="refresh-circle-outline" class="text-base text-emerald-500"></ion-icon>
              <span>Reset</span>
            </button>
          </div>
        </form>
        <p class="text-xs text-slate-500">Cell shading cues required fills: green &le;100, yellow 101300, orange 301600, red &gt;600.</p>
        <div class="rounded-2xl border border-slate-200 bg-white overflow-x-auto" id="breakeven-matrix-table">
          <div class="p-4 text-sm text-slate-500">Adjust inputs above and click Generate to build the breakeven matrix.</div>
        </div>
      </section>
    </div>
  </div>
<script>
  (function(){
    const DEFAULT_PRICE_PRECISION = 2;
    const BREAKEVEN_DEFAULTS = {
      maxLevels: 15,
      tpList: '1,2,3,4,5'
    };
    const BREAKEVEN_SHADES = [
      { max: 100, className: 'bg-emerald-50 text-emerald-700' },
      { max: 300, className: 'bg-yellow-50 text-yellow-700' },
      { max: 600, className: 'bg-orange-50 text-orange-700' },
      { max: Infinity, className: 'bg-red-50 text-red-700' }
    ];
    const THEME_STORAGE_KEY = 'grid_theme';
    const THEME_DARK = 'dark';
    const THEME_LIGHT = 'light';
    let activeTab = 'grid-calculator';
    let LAST_GRID_JSON = '';
    let gridOverviewChart = null;
    let gridPlChart = null;
    let gridCashflowChart = null;
    let gridSharesChart = null;

    function applyTheme(theme) {
      const next = theme === THEME_DARK ? THEME_DARK : THEME_LIGHT;
      document.documentElement.setAttribute('data-theme', next);
      return next;
    }

    function getPreferredTheme() {
      try {
        const stored = localStorage.getItem(THEME_STORAGE_KEY);
        if (stored === THEME_DARK || stored === THEME_LIGHT) return stored;
      } catch {}
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return THEME_DARK;
      }
      return THEME_LIGHT;
    }

    function decimals(step) {
      if (!Number.isFinite(step)) return 0;
      const s = String(step);
      const idx = s.indexOf('.');
      return idx === -1 ? 0 : (s.length - idx - 1);
    }

    function roundTo(value, step) {
      const d = decimals(step);
      return Number(value.toFixed(d));
    }

    function snapToTick(value, tick) {
      if (!Number.isFinite(value) || !Number.isFinite(tick) || tick <= 0) return value;
      const snapped = Math.round(value / tick) * tick;
      const d = decimals(tick);
      return Number(snapped.toFixed(Math.min(Math.max(d, 0), 8)));
    }

    function adjustNumberInput(id, deltaUnits) {
      const el = document.getElementById(id);
      if (!el) return;
      const stepAttr = parseFloat(el.getAttribute('step') || '1');
      const step = Number.isFinite(stepAttr) && stepAttr > 0 ? stepAttr : 1;
      const minAttr = parseFloat(el.getAttribute('min'));
      const maxAttr = parseFloat(el.getAttribute('max'));
      const defAttr = parseFloat(el.getAttribute('data-default'));
      const curVal = parseFloat(el.value);
      const base = Number.isFinite(curVal) ? curVal : (Number.isFinite(defAttr) ? defAttr : 0);
      const next = base + (Number(deltaUnits) || 0) * step;
      const clamped = Math.min(Number.isFinite(maxAttr) ? maxAttr : Infinity, Math.max(Number.isFinite(minAttr) ? minAttr : -Infinity, next));
      const rounded = roundTo(clamped, step);
      el.value = String(rounded);
      el.dispatchEvent(new Event('change', { bubbles: true }));
      el.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function updateGridSizeLabel() {
      const label = document.getElementById('gridSizeLabel');
      const spacingType = (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase();
      if (label) {
        label.textContent = spacingType === 'percent' ? 'Grid Size (%)' : 'Grid Size ($)';
      }
      const input = document.getElementById('inpGridSize');
      if (input) {
        if (spacingType === 'percent') {
          input.min = '1';
          input.step = '1';
          input.setAttribute('min', '1');
          input.setAttribute('step', '1');
        } else {
          input.min = '0.5';
          input.step = '0.5';
          input.setAttribute('min', '0.5');
          input.setAttribute('step', '0.5');
        }
      }
      renderGridLadder();
    }

    function readNumericInput(id) {
      const el = document.getElementById(id);
      if (!el) return NaN;
      const val = parseFloat(el.value);
      return Number.isFinite(val) ? val : NaN;
    }

    function calculateGridLadder(params) {
      const rawStartPrice = Number(params?.startPrice);
      const spacingType = (params?.spacingType || 'percent').toLowerCase();
      const gridSize = Number(params?.gridSize);
      const levelCount = Math.max(0, Math.floor(Number(params?.levelCount ?? params?.rungCount)));
      const levelsUp = Math.max(0, Math.floor(Number(params?.levelsUp)));
      const tradeAmount = Math.max(0, Number(params?.tradeAmount));
      const shareCountRaw = Number(params?.shares);
      const shareCount = Number.isFinite(shareCountRaw) && shareCountRaw > 0 ? shareCountRaw : 0;
      const tickSize = Number(params?.tickSize);
      const resolvedTickSize = Number.isFinite(tickSize) && tickSize > 0 ? tickSize : 0.01;
      const startPrice = snapToTick(rawStartPrice, resolvedTickSize);
      const precision = Math.max(DEFAULT_PRICE_PRECISION, decimals(resolvedTickSize));
      if (!Number.isFinite(startPrice) || startPrice <= 0) return { rows: [], summary: null, stepSize: null, precision };
      if (!Number.isFinite(gridSize) || gridSize <= 0) return { rows: [], summary: null, stepSize: null, precision };
      if (!Number.isFinite(levelCount) || levelCount <= 0) return { rows: [], summary: null, stepSize: null, precision };
      const perLevelInvestment = Number.isFinite(tradeAmount) && tradeAmount > 0 ? tradeAmount : 0;
      const investedForLevel = (level) => perLevelInvestment > 0 ? perLevelInvestment * level : 0;
      const entryPrices = perLevelInvestment > 0 ? [startPrice] : [];
      const computeTotalLoss = (currentPrice) => {
        if (perLevelInvestment <= 0 || !entryPrices.length) return 0;
        return entryPrices.reduce((sum, entryPrice) => {
          if (!Number.isFinite(entryPrice) || entryPrice <= 0) return sum;
          const dropFraction = Math.max(0, 1 - currentPrice / entryPrice);
          return sum + perLevelInvestment * dropFraction;
        }, 0);
      };

      const above = [];
      const below = [];
      const stepPercent = gridSize / 100;
      const usePercentSpacing = spacingType === 'percent';
      const aboveLimit = Math.max(0, Math.floor(levelsUp));

      let priceAccumulator = startPrice;
      let cumulativeSellCashflow = 0;
      let cumulativeSharesSold = 0;
      for (let i = 1; i <= aboveLimit; i++) {
        let price;
        if (usePercentSpacing) {
          const divisor = 1 - stepPercent;
          if (divisor <= 0) break;
          priceAccumulator = priceAccumulator / divisor;
          price = snapToTick(priceAccumulator, resolvedTickSize);
        } else {
          price = snapToTick(startPrice + gridSize * i, resolvedTickSize);
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        if (perLevelInvestment > 0) {
          cumulativeSellCashflow += perLevelInvestment;
        }
        if (shareCount > 0 && perLevelInvestment > 0) {
          cumulativeSharesSold += perLevelInvestment / price;
        }
        above.push({
          key: `above-${i}`,
          type: 'above',
          label: `+${i}`,
          level: i,
          price,
          diff,
          diffPct,
          direction: 'Above',
          cashflow: cumulativeSellCashflow,
          profitLoss: 0,
          costBasis: investedForLevel(i),
          sharesHeld: shareCount - cumulativeSharesSold
        });
      }

      priceAccumulator = startPrice;
      let cumulativeSharesBought = 0;
      for (let i = 1; i <= levelCount; i++) {
        let price;
        if (usePercentSpacing) {
          priceAccumulator = priceAccumulator * (1 - stepPercent);
          price = snapToTick(priceAccumulator, resolvedTickSize);
          if (price <= 0) break;
        } else {
          price = snapToTick(startPrice - gridSize * i, resolvedTickSize);
        }
        if (!Number.isFinite(price) || price <= 0) continue;
        const diff = price - startPrice;
        const diffPct = startPrice !== 0 ? (diff / startPrice) * 100 : 0;
        const totalLoss = computeTotalLoss(price);
        let sharesBought = 0;
        if (perLevelInvestment > 0) {
          sharesBought = perLevelInvestment / price;
          cumulativeSharesBought += sharesBought;
        }
        below.push({
          key: `below-${i}`,
          type: 'below',
          label: `-${i}`,
          level: i,
          price,
          diff,
          diffPct,
          direction: 'Below',
          cashflow: -investedForLevel(i),
          profitLoss: -totalLoss,
          costBasis: investedForLevel(i),
          sharesHeld: shareCount + cumulativeSharesBought
        });
        if (perLevelInvestment > 0) {
          entryPrices.push(price);
        }
      }

      const startRow = {
        key: 'start',
        type: 'start',
        label: 'Start',
        level: 0,
        price: startPrice,
        diff: 0,
        diffPct: 0,
        direction: 'Start',
        cashflow: 0,
        profitLoss: 0,
        costBasis: 0,
        sharesHeld: shareCount
      };

      const allRows = [...above, startRow, ...below];
      allRows.sort((a, b) => b.price - a.price);
      const stepSize = usePercentSpacing ? null : snapToTick(gridSize, resolvedTickSize);

      return {
        rows: allRows,
        summary: {
          startPrice,
          spacingType,
          gridSize,
          levelCount,
          startShares: shareCount,
          tickSize: resolvedTickSize,
          aboveCount: above.length,
          belowCount: below.length
        },
        tradeAmount: perLevelInvestment,
        stepSize,
        precision
      };
    }

    function renderGridLadder() {
      const container = document.getElementById('gridLadderContainer');
      const summaryEl = document.getElementById('gridLadderSummary');
      if (!container) return;

      const params = {
        startPrice: readNumericInput('inpStartPrice'),
        spacingType: (document.getElementById('selGridSpacing')?.value || 'percent').toLowerCase(),
        gridSize: readNumericInput('inpGridSize'),
        levelCount: readNumericInput('inpLevelCount'),
        levelsUp: readNumericInput('inpLevelCountUp'),
        tradeAmount: readNumericInput('inpTradeAmount'),
        shares: readNumericInput('inpShares'),
        tickSize: readNumericInput('selTickSize')
      };
      const result = calculateGridLadder(params);
      if (!result.rows.length) {
        container.innerHTML = '<div class="p-4 text-sm text-slate-500">Enter a positive starting price, grid size, and levels down to draw the ladder.</div>';
        if (summaryEl) {
          summaryEl.textContent = 'Adjust the grid parameters to preview ladder levels around the starting price.';
        }
        updateGridOverviewChart(result);
        updateGridPlChart(result);
        updateGridCashflowChart(result);
        updateGridSharesChart(result);
        renderGridExplanation(result);
        renderGridJson(result);
        return;
      }

      const { rows, summary, stepSize, precision, tradeAmount } = result;
      const priceFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const sharesFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 });
      const diffFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: precision,
        maximumFractionDigits: precision
      });
      const pctFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const cashFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const showInvestmentMetrics = Number.isFinite(tradeAmount) && tradeAmount > 0;
      const perLevelInvestment = showInvestmentMetrics ? Number(tradeAmount) : 0;
      const showSharesColumn = true;

      const spacingDescriptor = summary.spacingType === 'percent'
        ? `${Number(summary.gridSize).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 })}% per level (compounded)`
        : `$${diffFormatter.format(summary.gridSize)} spacing`;
      const stepDescriptor = Number.isFinite(stepSize)
        ? ` $${diffFormatter.format(stepSize)} between levels`
        : '';
      if (summaryEl) {
        const startStr = priceFormatter.format(summary.startPrice);
        const stepSuffix = stepDescriptor ? `, ${stepDescriptor}` : '';
        summaryEl.textContent = `Grid ladder: showing ${summary.aboveCount} level(s) above and ${summary.belowCount} level(s) below $${startStr} with ${spacingDescriptor}${stepSuffix}.`;
      }

      const rowHtml = rows.map(row => {
        const isStart = row.type === 'start';
        const diffClass = row.diff > 0 ? 'num-pos' : (row.diff < 0 ? 'num-neg' : 'text-slate-500');
        const pctClass = row.diffPct > 0 ? 'num-pos' : (row.diffPct < 0 ? 'num-neg' : 'text-slate-500');
        const diffAbs = diffFormatter.format(Math.abs(row.diff));
        const pctAbs = pctFormatter.format(Math.abs(row.diffPct));
        const diffText = row.diff === 0 ? `$${diffFormatter.format(0)}` : `${row.diff > 0 ? '+' : '-'}$${diffAbs}`;
        const pctText = row.diffPct === 0 ? `${pctFormatter.format(0)}%` : `${row.diffPct > 0 ? '+' : '-'}${pctAbs}%`;
        const cashflowValue = showInvestmentMetrics ? Number(row.cashflow) || 0 : 0;
        const cashflowText = showInvestmentMetrics
          ? (cashflowValue === 0 ? '$0.00' : `${cashflowValue > 0 ? '+' : '-'}$${cashFormatter.format(Math.abs(cashflowValue))}`)
          : '';
        const cashflowClass = cashflowValue > 0 ? 'num-pos' : (cashflowValue < 0 ? 'num-neg' : 'text-slate-500');
        const showGridPLMetrics = showInvestmentMetrics && row.type !== 'above';
        const profitLossValue = showGridPLMetrics ? Number(row.profitLoss) || 0 : 0;
        const profitLossText = showGridPLMetrics
          ? (profitLossValue === 0 ? '$0.00' : `${profitLossValue > 0 ? '+' : '-'}$${cashFormatter.format(Math.abs(profitLossValue))}`)
          : '-';
        const profitLossClass = showGridPLMetrics
          ? (profitLossValue > 0 ? 'num-pos' : (profitLossValue < 0 ? 'num-neg' : 'text-slate-500'))
          : 'text-slate-500';
        const costBasis = showGridPLMetrics ? Number(row.costBasis) || 0 : 0;
        const profitLossPctValue = costBasis > 0 ? (profitLossValue / costBasis) * 100 : 0;
        const profitLossPctText = showGridPLMetrics
          ? (profitLossPctValue === 0 ? '0.00%' : `${profitLossPctValue > 0 ? '+' : '-'}${pctFormatter.format(Math.abs(profitLossPctValue))}%`)
          : '-';
        const profitLossPctClass = showGridPLMetrics
          ? (profitLossPctValue > 0 ? 'num-pos' : (profitLossPctValue < 0 ? 'num-neg' : 'text-slate-500'))
          : 'text-slate-500';
        const baseCellClass = `px-4 py-2 text-sm ${isStart ? 'text-emerald-700 font-semibold' : 'text-slate-700'}`;
        const sharesCellClass = `px-4 py-2 text-sm ${isStart ? 'text-emerald-700 font-semibold' : 'text-slate-700'}`;
        const mvCellClass = `px-4 py-2 text-sm ${isStart ? 'text-emerald-700 font-semibold' : 'text-slate-700'}`;
        const sharesRemaining = Number.isFinite(row.sharesHeld) ? row.sharesHeld : NaN;
        const sharesText = Number.isFinite(sharesRemaining) ? sharesFormatter.format(sharesRemaining) : '';
        const startShares = Number.isFinite(summary?.startShares) ? summary.startShares : 0;
        const gridMvValue = Number.isFinite(sharesRemaining) ? sharesRemaining * row.price : NaN;
        const bhMvValue = startShares * row.price;
        const formatMoney = (value) => {
          if (!Number.isFinite(value)) return '';
          if (value === 0) return '$0.00';
          const sign = value < 0 ? '-' : '';
          return `${sign}$${cashFormatter.format(Math.abs(value))}`;
        };
        const gridMvText = formatMoney(gridMvValue);
        const gridEquityValue = Number.isFinite(gridMvValue)
          ? gridMvValue + (showInvestmentMetrics ? cashflowValue : 0)
          : NaN;
        const gridEquityText = formatMoney(gridEquityValue);
        const bhMvText = formatMoney(bhMvValue);
        const gridPlValue = showGridPLMetrics ? profitLossValue : 0;
        const gridVsBhDelta = (Number.isFinite(gridEquityValue) ? gridEquityValue : 0) - (Number.isFinite(bhMvValue) ? bhMvValue : 0);
        const gridVsBhDeltaPct = Number.isFinite(bhMvValue) && bhMvValue !== 0
          ? (gridVsBhDelta / bhMvValue) * 100
          : NaN;
        const deltaText = formatMoney(gridVsBhDelta);
        const deltaPctText = Number.isFinite(gridVsBhDeltaPct)
          ? (gridVsBhDeltaPct === 0 ? '0.00%' : `${gridVsBhDeltaPct > 0 ? '+' : '-'}${pctFormatter.format(Math.abs(gridVsBhDeltaPct))}%`)
          : '';
        const deltaClass = gridVsBhDelta > 0 ? 'num-pos' : (gridVsBhDelta < 0 ? 'num-neg' : 'text-slate-500');
        const deltaPctClass = gridVsBhDeltaPct > 0 ? 'num-pos' : (gridVsBhDeltaPct < 0 ? 'num-neg' : 'text-slate-500');
        return `
          <tr class="table-row${isStart ? ' table-row-selected' : ''}">
            <td class="${baseCellClass}">${row.label}</td>
            <td class="${baseCellClass}">$${priceFormatter.format(row.price)}</td>
            <td class="px-4 py-2 text-sm ${diffClass}">${diffText}</td>
            <td class="px-4 py-2 text-sm ${pctClass}">${pctText}</td>
            <td class="px-4 py-2 text-sm ${cashflowClass}">${cashflowText}</td>
            <td class="px-4 py-2 text-sm ${profitLossClass}">${profitLossText}</td>
            <td class="px-4 py-2 text-sm ${profitLossPctClass}">${profitLossPctText}</td>
            ${showSharesColumn ? `<td class="${sharesCellClass}">${sharesText}</td>` : ''}
            <td class="${mvCellClass}">${gridMvText}</td>
            <td class="${mvCellClass}">${gridEquityText}</td>
            <td class="${mvCellClass}">${bhMvText}</td>
            <td class="px-4 py-2 text-sm ${deltaClass}">${deltaText}</td>
            <td class="px-4 py-2 text-sm ${deltaPctClass}">${deltaPctText}</td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
            <tr>
              <th scope="col" class="px-4 py-2 text-left">Level</th>
              <th scope="col" class="px-4 py-2 text-left">Price</th>
              <th scope="col" class="px-4 py-2 text-left">Buy-and-Hold P/L ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Buy-and-Hold Return (%)</th>
              <th scope="col" class="px-4 py-2 text-left">Cashflow ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Grid P/L ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Grid P/L (%)</th>
              ${showSharesColumn ? '<th scope="col" class="px-4 py-2 text-left">Shares</th>' : ''}
              <th scope="col" class="px-4 py-2 text-left">Grid MV</th>
              <th scope="col" class="px-4 py-2 text-left">Grid Equity</th>
              <th scope="col" class="px-4 py-2 text-left">B&H MV</th>
              <th scope="col" class="px-4 py-2 text-left">Grid  vs B&amp;H ($)</th>
              <th scope="col" class="px-4 py-2 text-left">Grid  vs B&amp;H (%)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            ${rowHtml}
          </tbody>
        </table>
      `;

      updateGridOverviewChart(result);
      updateGridPlChart(result);
      updateGridCashflowChart(result);
      updateGridSharesChart(result);
      renderGridExplanation(result);
      renderGridJson(result);
    }

    function renderGridExplanation(result) {
      const briefEl = document.getElementById('gridExplainBrief');
      const compactEl = document.getElementById('gridExplainCompact');
      const verboseEl = document.getElementById('gridExplainVerbose');
      if (!briefEl || !compactEl || !verboseEl) return;

      if (!result || !Array.isArray(result.rows) || !result.rows.length || !result.summary) {
        const placeholder = 'Run the calculator to generate explanation text.';
        briefEl.textContent = placeholder;
        compactEl.textContent = placeholder;
        verboseEl.textContent = placeholder;
        return;
      }

      const summary = result.summary || {};
      const startPrice = Number(summary.startPrice);
      const startShares = Number.isFinite(summary.startShares) ? summary.startShares : 0;
      const gridSize = Number(summary.gridSize);
      const spacingType = (summary.spacingType || 'percent').toLowerCase();
      const tradeAmount = Number(result.tradeAmount);
      const levelsUp = Number.isFinite(summary.aboveCount) ? summary.aboveCount : 0;
      const levelsDown = Number.isFinite(summary.belowCount) ? summary.belowCount : 0;
      const tickSize = Number(summary.tickSize);
      const resolvedTickSize = Number.isFinite(tickSize) && tickSize > 0 ? tickSize : 0.01;
      const pricePrecision = Math.max(DEFAULT_PRICE_PRECISION, decimals(resolvedTickSize));

      const priceFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: pricePrecision,
        maximumFractionDigits: pricePrecision
      });
      const cashFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const sharesFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
      });
      const pctFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      const formatMoney = (value) => {
        if (!Number.isFinite(value)) return '';
        const sign = value < 0 ? '-' : '';
        return `${sign}$${cashFormatter.format(Math.abs(value))}`;
      };
      const formatPct = (value, withSign = false) => {
        if (!Number.isFinite(value)) return '';
        const pct = value * 100;
        const sign = withSign ? (pct > 0 ? '+' : (pct < 0 ? '-' : '')) : (pct < 0 ? '-' : '');
        return `${sign}${pctFormatter.format(Math.abs(pct))}%`;
      };
      const fmtShares = (value) => (Number.isFinite(value) ? sharesFormatter.format(value) : '');
      const fmtPrice = (value) => (Number.isFinite(value) ? `$${priceFormatter.format(value)}` : '');
      const fmtLevel = (value) => {
        if (!Number.isFinite(value)) return '';
        if (value > 0) return `+${value}`;
        return `${value}`;
      };

      const gridDownPct = spacingType === 'percent'
        ? gridSize / 100
        : (Number.isFinite(startPrice) && startPrice !== 0 ? gridSize / startPrice : NaN);
      const downStepPct = gridDownPct;
      const upStep = Number.isFinite(gridDownPct) && gridDownPct > 0 && gridDownPct < 1
        ? 1 / (1 - gridDownPct)
        : NaN;
      const upStepPct = Number.isFinite(upStep) ? upStep - 1 : NaN;
      const downStepMultiplier = Number.isFinite(gridDownPct) ? (1 - gridDownPct) : NaN;

      const priceAtLevel = (k) => {
        if (!Number.isFinite(startPrice)) return NaN;
        if (k === 0) return startPrice;
        if (spacingType === 'percent') {
          const step = 1 - gridDownPct;
          if (!Number.isFinite(step) || step <= 0) return NaN;
          const multiplier = k > 0
            ? Math.pow(1 / step, k)
            : Math.pow(step, Math.abs(k));
          return snapToTick(startPrice * multiplier, resolvedTickSize);
        }
        return snapToTick(startPrice + gridSize * k, resolvedTickSize);
      };

      const sharesAtLevel = (k) => {
        if (!Number.isFinite(startShares)) return NaN;
        let shares = startShares;
        if (!Number.isFinite(tradeAmount) || tradeAmount === 0) return shares;
        const steps = Math.abs(Math.trunc(k));
        for (let i = 1; i <= steps; i++) {
          const level = k > 0 ? i : -i;
          const price = priceAtLevel(level);
          if (!Number.isFinite(price) || price <= 0) return NaN;
          const delta = tradeAmount / price;
          shares += k > 0 ? -delta : delta;
        }
        return shares;
      };

      const cashExtractedAtLevel = (k) => (Number.isFinite(tradeAmount) ? tradeAmount * k : 0);

      const rowByLevel = new Map();
      result.rows.forEach((row) => {
        const level = row?.type === 'below'
          ? -Number(row.level || 0)
          : (row?.type === 'above' ? Number(row.level || 0) : 0);
        rowByLevel.set(level, row);
      });

      const buildLevelMetrics = (k) => {
        const level = Math.trunc(k);
        const row = rowByLevel.get(level);
        const price = row && Number.isFinite(row.price) ? Number(row.price) : priceAtLevel(level);
        const shares = row && Number.isFinite(row.sharesHeld) ? Number(row.sharesHeld) : sharesAtLevel(level);
        const cash = row && Number.isFinite(row.cashflow) ? Number(row.cashflow) : cashExtractedAtLevel(level);
        const gridMV = Number.isFinite(price) && Number.isFinite(shares) ? price * shares : NaN;
        const gridEquity = Number.isFinite(gridMV) ? gridMV + cash : NaN;
        const bhMV = Number.isFinite(price) ? startShares * price : NaN;
        const delta = Number.isFinite(gridEquity) && Number.isFinite(bhMV) ? gridEquity - bhMV : NaN;
        const deltaPct = Number.isFinite(bhMV) && bhMV !== 0 && Number.isFinite(delta) ? delta / bhMV : NaN;
        return { level, price, shares, gridMV, cashflow: cash, gridEquity, bhMV, delta, deltaPct };
      };

      let sharesNeededInfinite = NaN;
      if (spacingType === 'percent'
        && Number.isFinite(gridDownPct)
        && gridDownPct > 0
        && gridDownPct < 1
        && Number.isFinite(startPrice)
        && startPrice > 0
        && Number.isFinite(tradeAmount)
        && tradeAmount > 0) {
        sharesNeededInfinite = (tradeAmount / startPrice) * ((1 - gridDownPct) / gridDownPct);
      }
      const isInfinite = Number.isFinite(sharesNeededInfinite) && startShares >= sharesNeededInfinite;
      const tailShares = isInfinite ? Math.max(0, startShares - sharesNeededInfinite) : 0;

      const computeMaxSellableLevelsUp = () => {
        if (isInfinite) return Infinity;
        if (!Number.isFinite(tradeAmount) || tradeAmount <= 0) return 0;
        if (!Number.isFinite(startShares) || startShares <= 0) return 0;
        let shares = startShares;
        const maxIterations = 5000;
        for (let level = 1; level <= maxIterations; level++) {
          const price = priceAtLevel(level);
          if (!Number.isFinite(price) || price <= 0) return level - 1;
          const sharesToSell = tradeAmount / price;
          if (shares < sharesToSell - 1e-9) return level - 1;
          shares -= sharesToSell;
        }
        return maxIterations;
      };

      const maxSellableLevelsUp = computeMaxSellableLevelsUp();
      const hasFiniteSellCap = Number.isFinite(maxSellableLevelsUp);
      const sellLevelsShown = hasFiniteSellCap
        ? Math.min(levelsUp, maxSellableLevelsUp)
        : levelsUp;
      const runOutLevelUp = hasFiniteSellCap && levelsUp > maxSellableLevelsUp
        ? maxSellableLevelsUp + 1
        : null;
      const runOutPriceUp = Number.isFinite(runOutLevelUp) ? priceAtLevel(runOutLevelUp) : NaN;

      const downMetrics = buildLevelMetrics(-levelsDown);
      const upMetrics = buildLevelMetrics(sellLevelsShown);

      const deltaMoneySpan = (value) => {
        if (!Number.isFinite(value)) return '<span class="text-slate-500"></span>';
        const cls = value > 0 ? 'num-pos' : (value < 0 ? 'num-neg' : 'text-slate-500');
        return `<span class="${cls}">${formatMoney(value)}</span>`;
      };
      const deltaPctSpan = (value) => {
        if (!Number.isFinite(value)) return '<span class="text-slate-500"></span>';
        const cls = value > 0 ? 'num-pos' : (value < 0 ? 'num-neg' : 'text-slate-500');
        return `<span class="${cls}">${formatPct(value, true)}</span>`;
      };

      const baseValue = Number.isFinite(startShares) && Number.isFinite(startPrice) ? startShares * startPrice : NaN;
      const hasUpside = startShares > 0;

      const downsideBriefLines = [
        `Starting with ${fmtShares(startShares)} shares @ ${fmtPrice(startPrice)}, this grid buys ${formatMoney(tradeAmount)} each time price drops ${formatPct(downStepPct)}. After ${levelsDown} down-levels (price ${fmtPrice(downMetrics.price)}) you'd hold ${fmtShares(downMetrics.shares)} shares and have invested ${formatMoney(Math.abs(downMetrics.cashflow))} net.`
      ];
      if (startShares > 0) {
        downsideBriefLines.push(`GRID equity would be ${formatMoney(downMetrics.gridEquity)} vs B&H ${formatMoney(downMetrics.bhMV)} -> Delta ${deltaMoneySpan(downMetrics.delta)} (${deltaPctSpan(downMetrics.deltaPct)}).`);
      }
      const upsideBriefLines = [
        `This grid sells ${formatMoney(tradeAmount)} each time price rises ${formatPct(upStepPct)}. After ${sellLevelsShown} up-levels (price ${fmtPrice(upMetrics.price)}) you'd have ${fmtShares(upMetrics.shares)} shares remaining and extracted ${formatMoney(upMetrics.cashflow)} cash.`
      ];
      if (Number.isFinite(runOutLevelUp)) {
        upsideBriefLines.push(`It runs out of shares near level ${fmtLevel(runOutLevelUp)} (approx ${fmtPrice(runOutPriceUp)}).`);
      } else if (isInfinite) {
        upsideBriefLines.push(`Infinite inventory: it never runs out of shares to sell (retains ~${fmtShares(tailShares)} shares).`);
      }
      const briefHtmlParts = [
        `<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Downside (Accumulation)</div>${downsideBriefLines.map(line => `<p>${line}</p>`).join('')}</div>`
      ];
      if (hasUpside) {
        briefHtmlParts.push(`<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Upside (Distribution)</div>${upsideBriefLines.map(line => `<p>${line}</p>`).join('')}</div>`);
      }
      briefEl.innerHTML = briefHtmlParts.join('');

      const compactDownsideItems = [
        `Start: ${fmtShares(startShares)} shares @ ${fmtPrice(startPrice)}`,
        `Rule: Buy ${formatMoney(tradeAmount)} every ${formatPct(downStepPct)} drop`,
        `After ${levelsDown} levels down: price ${fmtPrice(downMetrics.price)}, shares ${fmtShares(downMetrics.shares)}, net invested ${formatMoney(Math.abs(downMetrics.cashflow))}`
      ];
      if (startShares > 0) {
        compactDownsideItems.push(`Value: GRID equity ${formatMoney(downMetrics.gridEquity)} vs B&H ${formatMoney(downMetrics.bhMV)} -> Delta ${deltaMoneySpan(downMetrics.delta)} (${deltaPctSpan(downMetrics.deltaPct)})`);
      }
      const compactSections = [
        `<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Downside (Accumulation)</div><ul class="list-disc pl-5 space-y-1">${compactDownsideItems.map(item => `<li>${item}</li>`).join('')}</ul></div>`
      ];
      if (hasUpside) {
        const compactUpsideItems = [
          `Rule: Sell ${formatMoney(tradeAmount)} every ${formatPct(upStepPct)} rise`,
          `After ${sellLevelsShown} levels up: price ${fmtPrice(upMetrics.price)}, shares ${fmtShares(upMetrics.shares)}, cash extracted ${formatMoney(upMetrics.cashflow)}`,
          `Value: GRID equity ${formatMoney(upMetrics.gridEquity)} vs B&H ${formatMoney(upMetrics.bhMV)} -> Delta ${deltaMoneySpan(upMetrics.delta)} (${deltaPctSpan(upMetrics.deltaPct)})`
        ];
        if (Number.isFinite(runOutLevelUp)) {
          compactUpsideItems.push(`Finite: runs out near level ${fmtLevel(runOutLevelUp)} (approx ${fmtPrice(runOutPriceUp)})`);
        } else if (isInfinite) {
          compactUpsideItems.push(`Infinite: never runs out (retains ~${fmtShares(tailShares)} shares)`);
        }
        compactSections.push(`<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Upside (Distribution)</div><ul class="list-disc pl-5 space-y-1">${compactUpsideItems.map(item => `<li>${item}</li>`).join('')}</ul></div>`);
      }
      compactEl.innerHTML = compactSections.join('');

      const verboseSections = [];
      const verboseDownsideLines = [
        'This calculator is a one-way ladder (no oscillations): it shows what your inventory and net cash invested or extracted would look like if price stepped rung-by-rung away from the start.',
        `Downside (Accumulation): Starting with ${fmtShares(startShares)} shares @ ${fmtPrice(startPrice)}, the grid buys ${formatMoney(tradeAmount)} each time price drops ${formatPct(downStepPct)} (prices step by x${formatPct(downStepMultiplier)} each rung). Each buy adds approximately tradeAmount / rung price shares, so you accumulate more shares as price falls.`,
        `After ${levelsDown} down-levels, price is ${fmtPrice(downMetrics.price)}, shares held are ${fmtShares(downMetrics.shares)}, and net capital invested from level 0 is ${formatMoney(Math.abs(downMetrics.cashflow))}. The remaining inventory is worth ${formatMoney(downMetrics.gridMV)}, so total GRID equity (inventory + net cashflow) is ${formatMoney(downMetrics.gridEquity)}.`
      ];
      if (startShares > 0) {
        verboseDownsideLines.push(`At this same price, Buy & Hold would be worth ${formatMoney(downMetrics.bhMV)}, so GRID is ${deltaMoneySpan(downMetrics.delta)} (${deltaPctSpan(downMetrics.deltaPct)}) vs holding at this point on the ladder.`);
      } else {
        verboseDownsideLines.push('(Buy & Hold comparisons are omitted because you started with zero inventory.)');
      }
      verboseSections.push(`<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Downside (Accumulation)</div>${verboseDownsideLines.map(line => `<p>${line}</p>`).join('')}</div>`);
      if (hasUpside) {
        const verboseUpsideLines = [
          `Upside (Distribution): On the way up, the grid sells ${formatMoney(tradeAmount)} notional each time price rises ${formatPct(upStepPct)} (prices step by x${formatPct(upStep)} per rung). Because you sell a fixed dollar amount, shares sold per rung = tradeAmount / rung price, so you sell fewer shares as price rises.`,
          `After ${sellLevelsShown} up-levels, price is ${fmtPrice(upMetrics.price)}, shares remaining are ${fmtShares(upMetrics.shares)}, and cash extracted is ${formatMoney(upMetrics.cashflow)}. Inventory market value is ${formatMoney(upMetrics.gridMV)}, so GRID equity is ${formatMoney(upMetrics.gridEquity)}.`,
          `At the same price, Buy & Hold would be worth ${formatMoney(upMetrics.bhMV)}. The difference (${deltaMoneySpan(upMetrics.delta)} / ${deltaPctSpan(upMetrics.deltaPct)}) is the opportunity cost of de-risking into cash during an uninterrupted rise.`
        ];
        if (Number.isFinite(runOutLevelUp)) {
          verboseUpsideLines.push(`This setup is finite on the upside: it runs out of shares to sell near level ${fmtLevel(runOutLevelUp)} (approx ${fmtPrice(runOutPriceUp)}).`);
        } else if (isInfinite) {
          verboseUpsideLines.push(`This setup is an infinite inventory grid: it never runs out of shares to sell and asymptotically retains ~${fmtShares(tailShares)} shares.`);
        }
        verboseSections.push(`<div class="space-y-2"><div class="text-xs font-semibold uppercase tracking-wide text-slate-500">Upside (Distribution)</div>${verboseUpsideLines.map(line => `<p>${line}</p>`).join('')}</div>`);
      }
      verboseEl.innerHTML = verboseSections.join('');
    }

    function updateGridOverviewChart(result) {
      const canvas = document.getElementById('gridOverviewChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridOverviewChart) {
          gridOverviewChart.destroy();
          gridOverviewChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const startShares = Number.isFinite(result?.summary?.startShares) ? Number(result.summary.startShares) : 0;
      const buyHold = chartRows.map((row) => {
        const price = Number(row?.price) || 0;
        return startShares * price;
      });
      const gridEquity = chartRows.map((row) => {
        const price = Number(row?.price) || 0;
        const shares = Number(row?.sharesHeld) || 0;
        const cashflow = Number(row?.cashflow) || 0;
        return shares * price + cashflow;
      });
      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      const formatCurrency = (value) => {
        const sign = value < 0 ? '-' : '';
        return `${sign}$${currencyFormatter.format(Math.abs(value))}`;
      };

      const data = {
        labels,
        datasets: [
          {
            label: 'Buy-and-Hold MV ($)',
            data: buyHold,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          },
          {
            label: 'Grid Equity ($)',
            data: gridEquity,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Buy-and-Hold MV vs Grid Equity Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Value ($)' },
            ticks: {
              callback: (val) => formatCurrency(Number(val))
            }
          }
        }
      };

      if (gridOverviewChart) {
        gridOverviewChart.data = data;
        gridOverviewChart.options = options;
        gridOverviewChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridOverviewChart = new Chart(ctx, { type: 'line', data, options });
    }

    function updateGridPlChart(result) {
      const canvas = document.getElementById('gridPlChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridPlChart) {
          gridPlChart.destroy();
          gridPlChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const gridPL = chartRows.map((row) => Number(row?.profitLoss) || 0);
      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      const formatCurrency = (value) => {
        const sign = value < 0 ? '-' : '';
        return `${sign}$${currencyFormatter.format(Math.abs(value))}`;
      };

      const data = {
        labels,
        datasets: [
          {
            label: 'Grid P/L ($)',
            data: gridPL,
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Grid Strategy Profit and Loss Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Grid P/L ($)' },
            ticks: {
              callback: (val) => formatCurrency(Number(val))
            }
          }
        }
      };

      if (gridPlChart) {
        gridPlChart.data = data;
        gridPlChart.options = options;
        gridPlChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridPlChart = new Chart(ctx, { type: 'line', data, options });
    }

    function updateGridCashflowChart(result) {
      const canvas = document.getElementById('gridCashflowChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridCashflowChart) {
          gridCashflowChart.destroy();
          gridCashflowChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const cashflow = chartRows.map((row) => Number(row?.cashflow) || 0);
      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      const formatCurrency = (value) => {
        const sign = value < 0 ? '-' : '';
        return `${sign}$${currencyFormatter.format(Math.abs(value))}`;
      };

      const data = {
        labels,
        datasets: [
          {
            label: 'Net Cashflow ($)',
            data: cashflow,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Net Cashflow Across Grid Levels'
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${formatCurrency(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Net Cashflow ($)' },
            ticks: {
              callback: (val) => formatCurrency(Number(val))
            }
          }
        }
      };

      if (gridCashflowChart) {
        gridCashflowChart.data = data;
        gridCashflowChart.options = options;
        gridCashflowChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridCashflowChart = new Chart(ctx, { type: 'line', data, options });
    }

    function updateGridSharesChart(result) {
      const canvas = document.getElementById('gridSharesChart');
      if (!canvas || typeof Chart === 'undefined') return;
      const rows = Array.isArray(result?.rows) ? result.rows : [];
      if (!rows.length) {
        if (gridSharesChart) {
          gridSharesChart.destroy();
          gridSharesChart = null;
        }
        return;
      }

      const signedLevel = (row) => {
        if (row?.type === 'below') return -Number(row.level || 0);
        if (row?.type === 'above') return Number(row.level || 0);
        return 0;
      };

      const chartRows = rows.slice().sort((a, b) => signedLevel(a) - signedLevel(b));
      const labels = chartRows.map((row) => String(signedLevel(row)));
      const shares = chartRows.map((row) => Number(row?.sharesHeld) || 0);
      const sharesFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 4
      });

      const data = {
        labels,
        datasets: [
          {
            label: 'Shares Held',
            data: shares,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.12)',
            tension: 0.25,
            pointRadius: 3,
            pointHoverRadius: 4,
            order: 1
          },
          {
            label: 'Zero Line',
            data: labels.map(() => 0),
            borderColor: 'rgba(148, 163, 184, 0.85)',
            borderDash: [6, 6],
            borderWidth: 1,
            pointRadius: 0,
            pointHoverRadius: 0,
            fill: false,
            order: 0
          }
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            position: 'bottom',
            labels: { usePointStyle: true }
          },
          title: {
            display: true,
            text: 'Shares Held vs Grid Level'
          },
          tooltip: {
            filter: (context) => context.datasetIndex === 0,
            callbacks: {
              label: (context) => {
                const label = context.dataset.label || '';
                const value = Number(context.parsed?.y) || 0;
                return `${label}: ${sharesFormatter.format(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Level' }
          },
          y: {
            title: { display: true, text: 'Shares' },
            ticks: {
              callback: (val) => sharesFormatter.format(Number(val))
            }
          }
        }
      };

      if (gridSharesChart) {
        gridSharesChart.data = data;
        gridSharesChart.options = options;
        gridSharesChart.update();
        return;
      }

      const ctx = canvas.getContext('2d');
      gridSharesChart = new Chart(ctx, { type: 'line', data, options });
    }

    function buildGridJsonFromResult(result) {
      if (!result || !Array.isArray(result.rows) || !result.rows.length || !result.summary) return null;
      const precision = Number.isInteger(result.precision) ? result.precision : DEFAULT_PRICE_PRECISION;
      const pricePrecision = Math.max(precision, 2);
      const formatPrice = (val) => Number(val ?? 0).toFixed(pricePrecision);
      const summary = result.summary;
      const basePriceRaw = summary.startPrice || 0;
      const basePrice = formatPrice(basePriceRaw);
      const downRows = result.rows
        .filter(row => row.type === 'below')
        .sort((a, b) => b.price - a.price);
      const upRows = result.rows
        .filter(row => row.type === 'above')
        .sort((a, b) => a.price - b.price);

      const levelsDown = downRows.map((row, idx) => {
        const sellSource = idx === 0 ? (summary.startPrice || basePriceRaw) : downRows[idx - 1].price;
        return {
          buy: formatPrice(row.price),
          sell: formatPrice(sellSource),
          active: false,
          hide: false
        };
      });

      const levelsUp = upRows.map((row, idx) => {
        const buySource = idx === 0 ? basePriceRaw : upRows[idx - 1].price;
        return {
          buy: formatPrice(buySource),
          sell: formatPrice(row.price),
          active: false,
          hide: false
        };
      });

      const levels = [...levelsDown, ...levelsUp];
      const rawSize = Number(summary.gridSize);
      const spacingType = (summary.spacingType || 'percent').toLowerCase();
      const size = Number.isFinite(rawSize)
        ? (spacingType === 'percent' ? rawSize.toFixed(4) : formatPrice(rawSize))
        : formatPrice(0);
      return {
        grid: {
          base_price: basePrice,
          size,
          levels
        }
      };
    }

    function renderGridJson(result) {
      const codeEl = document.getElementById('gridJsonCode');
      const copyBtn = document.getElementById('btnCopyGridJson');
      const labelSpan = copyBtn?.querySelector('[data-copy-label]');
      const payload = buildGridJsonFromResult(result);
      if (!codeEl) return;
      if (!payload) {
        codeEl.textContent = '// Adjust grid inputs above to generate JSON.';
        LAST_GRID_JSON = '';
        if (copyBtn) {
          copyBtn.disabled = true;
          if (labelSpan) labelSpan.textContent = 'Copy JSON';
        }
        return;
      }
      const pretty = formatGridJson(payload);
      codeEl.textContent = pretty;
      LAST_GRID_JSON = pretty;
      if (copyBtn) {
        copyBtn.disabled = false;
        if (labelSpan) labelSpan.textContent = 'Copy JSON';
      }
    }
    
    function formatGridJson(payload) {
      const indent = (level) => '  '.repeat(level);
      const grid = payload?.grid || {};
      const levels = Array.isArray(grid.levels) ? grid.levels : [];
      const formatPrice = (val) => {
        if (typeof val === 'string') return val;
        const num = Number(val ?? 0);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };
      const formatSize = (val) => {
        if (typeof val === 'string') return val;
        const num = Number(val ?? 0);
        return Number.isFinite(num) ? num.toFixed(2) : '0.00';
      };
      const lines = ['{', `${indent(1)}"grid": {`];
      lines.push(`${indent(2)}"base_price": ${formatPrice(grid.base_price)},`);
      lines.push(`${indent(2)}"size": ${formatSize(grid.size)},`);
      lines.push(`${indent(2)}"levels": [`);
      const sortedLevels = (Array.isArray(levels) ? levels : [])
        .map((level) => {
          const rawBuy = level?.buy ?? level?.buyPrice ?? level?.buy_price;
          const rawSell = level?.sell ?? level?.sellPrice ?? level?.sell_price;
          const parsedBuy = Number(rawBuy);
          return {
            rawBuy,
            rawSell,
            parsedBuy: Number.isFinite(parsedBuy) ? parsedBuy : 0,
            active: !!level?.active,
            hide: !!level?.hide
          };
        })
        .sort((a, b) => b.parsedBuy - a.parsedBuy);
      sortedLevels.forEach((level, idx) => {
        const comma = idx < sortedLevels.length - 1 ? ',' : '';
        const buy = formatPrice(level.rawBuy);
        const sell = formatPrice(level.rawSell);
        const active = level.active ? 'true' : 'false';
        const hide = level.hide ? 'true' : 'false';
        lines.push(`${indent(3)}{ "buy": ${buy}, "sell": ${sell}, "active": ${active}, "hide": ${hide} }${comma}`);
      });
      lines.push(`${indent(2)}]`);
      lines.push(`${indent(1)}}`, '}');
      return lines.join('\n');
    }

    async function copyGridJsonToClipboard(text) {
      if (!text) return false;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          // fall back to execCommand copy
        }
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.pointerEvents = 'none';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (err) {
        return false;
      }
    }

    function getBreakevenCellClass(value) {
      if (!Number.isFinite(value)) return 'bg-slate-100 text-slate-500';
      for (const bucket of BREAKEVEN_SHADES) {
        if (value <= bucket.max) return bucket.className;
      }
      return 'bg-slate-100 text-slate-500';
    }

    function parseBreakevenTpValues(rawList) {
      const source = typeof rawList === 'string' && rawList.trim().length ? rawList : BREAKEVEN_DEFAULTS.tpList;
      return source
        .split(',')
        .map((part) => parseFloat(part.trim()))
        .filter((val) => Number.isFinite(val) && val > 0)
        .map((val) => Number(val.toFixed(4)));
    }

    function generateBreakevenMatrix() {
      const maxLevelsInput = document.getElementById('inpBreakevenLevels');
      const tpListInput = document.getElementById('inpBreakevenTpList');
      const tableContainer = document.getElementById('breakeven-matrix-table');
      if (!maxLevelsInput || !tpListInput || !tableContainer) return;

      const parsedLevels = parseInt(maxLevelsInput.value, 10);
      const clampedLevels = Math.max(1, Math.min(200, Number.isFinite(parsedLevels) ? parsedLevels : BREAKEVEN_DEFAULTS.maxLevels));
      if (String(clampedLevels) !== maxLevelsInput.value) {
        maxLevelsInput.value = String(clampedLevels);
      }

      const tpValues = parseBreakevenTpValues(tpListInput.value);
      if (!tpValues.length) {
        tableContainer.innerHTML = '<div class="p-4 text-sm text-slate-500">Enter at least one valid TP% (greater than 0) to generate the matrix.</div>';
        return;
      }

      const tpFormatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 4 });
      const fillsFormatter = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 });
      const headerCells = tpValues.map((tp) => `<th scope="col" class="px-4 py-2 text-center">${tpFormatter.format(tp)}%</th>`).join('');

      let bodyHtml = '';
      for (let level = 1; level <= clampedLevels; level++) {
        const rowClass = `table-row ${level % 2 === 0 ? 'bg-slate-50/70' : 'bg-white'}`;
        const levelCell = `<td class="px-4 py-2 text-sm font-medium text-slate-700 text-left">${level}</td>`;
        const cells = tpValues.map((tp) => {
          const tpRatio = tp / 100;
          const fillsNeeded = tpRatio > 0 ? Math.ceil(level / tpRatio) : null;
          const cellClass = getBreakevenCellClass(fillsNeeded);
          const content = fillsNeeded != null ? fillsFormatter.format(fillsNeeded) : '';
          return `<td class="px-4 py-2 text-sm font-semibold text-center ${cellClass}">${content}</td>`;
        }).join('');
        bodyHtml += `<tr class="${rowClass}">${levelCell}${cells}</tr>`;
      }

      tableContainer.innerHTML = `
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-100 text-xs font-semibold uppercase tracking-wide text-slate-600">
            <tr>
              <th scope="col" class="px-4 py-2 text-left">Levels &darr;</th>
              ${headerCells}
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            ${bodyHtml}
          </tbody>
        </table>
      `;
    }

    function resetBreakevenInputs() {
      const levelInput = document.getElementById('inpBreakevenLevels');
      const tpInput = document.getElementById('inpBreakevenTpList');
      if (levelInput) levelInput.value = String(BREAKEVEN_DEFAULTS.maxLevels);
      if (tpInput) tpInput.value = BREAKEVEN_DEFAULTS.tpList;
      generateBreakevenMatrix();
    }

    function activateTab(tabName) {
      const normalized = tabName === 'breakeven-matrix' ? 'breakeven-matrix' : 'grid-calculator';
      activeTab = normalized;
      const buttons = document.querySelectorAll('[data-tab-button]');
      buttons.forEach((btn) => {
        const isActive = btn?.getAttribute('data-tab-button') === normalized;
        btn.classList.toggle('border-emerald-500', !!isActive);
        btn.classList.toggle('text-slate-900', !!isActive);
        btn.classList.toggle('text-slate-500', !isActive);
        btn.classList.toggle('border-transparent', !isActive);
        btn.classList.toggle('hover:text-slate-700', !isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      const panels = document.querySelectorAll('[data-tab-panel]');
      panels.forEach((panel) => {
        const isActive = panel?.getAttribute('data-tab-panel') === normalized;
        panel.classList.toggle('hidden', !isActive);
        if (isActive) {
          panel.removeAttribute('hidden');
        } else {
          panel.setAttribute('hidden', 'true');
        }
        panel.tabIndex = isActive ? 0 : -1;
      });
    }

    function setupTabs() {
      const buttons = document.querySelectorAll('[data-tab-button]');
      if (!buttons.length) return;
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-tab-button');
          activateTab(target);
        });
      });
      activateTab(activeTab);
    }

    function setupCarousel() {
      const carousel = document.getElementById('gridCarousel');
      if (!carousel) return;
      const track = carousel.querySelector('[data-carousel-track]');
      const slides = track ? Array.from(track.children) : [];
      if (!track || !slides.length) return;
      const prevBtn = carousel.querySelector('[data-carousel-prev]');
      const nextBtn = carousel.querySelector('[data-carousel-next]');
      const dots = Array.from(carousel.querySelectorAll('[data-carousel-dot]'));
      let index = 0;

      const update = () => {
        const maxIndex = slides.length - 1;
        index = Math.max(0, Math.min(index, maxIndex));
        track.style.transform = `translateX(-${index * 100}%)`;
        if (prevBtn) prevBtn.disabled = index === 0;
        if (nextBtn) nextBtn.disabled = index === maxIndex;
        dots.forEach((dot, idx) => {
          const isActive = idx === index;
          dot.classList.toggle('bg-emerald-500', isActive);
          dot.classList.toggle('bg-slate-300', !isActive);
          if (isActive) {
            dot.setAttribute('aria-current', 'true');
          } else {
            dot.removeAttribute('aria-current');
          }
        });
      };

      prevBtn?.addEventListener('click', () => {
        index -= 1;
        update();
      });
      nextBtn?.addEventListener('click', () => {
        index += 1;
        update();
      });
      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const nextIndex = Number(dot.getAttribute('data-carousel-dot'));
          if (Number.isFinite(nextIndex)) {
            index = nextIndex;
            update();
          }
        });
      });

      update();
    }

    document.addEventListener('click', (e) => {
      const controlBtn = e.target.closest('button[data-num-target][data-num-step]');
      if (controlBtn) {
        const id = controlBtn.getAttribute('data-num-target');
        const delta = parseFloat(controlBtn.getAttribute('data-num-step')) || 0;
        adjustNumberInput(id, delta);
        return;
      }
    });

    document.addEventListener('click', (e) => {
      const infoBtn = e.target.closest('[data-chart-info-toggle]');
      if (!infoBtn) return;
      const container = infoBtn.closest('.min-w-full') || document;
      const details = container.querySelector('[data-chart-info]');
      if (details) {
        details.open = !details.open;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('toggleTheme');
      const initialTheme = applyTheme(getPreferredTheme());
      if (themeToggle) {
        themeToggle.checked = initialTheme === THEME_DARK;
        themeToggle.addEventListener('change', () => {
          const next = themeToggle.checked ? THEME_DARK : THEME_LIGHT;
          applyTheme(next);
          try {
            localStorage.setItem(THEME_STORAGE_KEY, next);
          } catch {}
        });
      }
      const explainToggle = document.getElementById('toggleExplain');
      const explainPanel = document.getElementById('gridExplainPanel');
      const updateExplainPanel = () => {
        if (!explainPanel || !explainToggle) return;
        explainPanel.classList.toggle('hidden', !explainToggle.checked);
      };
      if (explainToggle) {
        explainToggle.checked = false;
        explainToggle.addEventListener('change', updateExplainPanel);
      }
      updateExplainPanel();
      const explainSegment = document.getElementById('gridExplainSegment');
      const explainButtons = explainSegment ? Array.from(explainSegment.querySelectorAll('[data-explain-view]')) : [];
      const explainPanels = {
        brief: document.getElementById('gridExplainBrief'),
        compact: document.getElementById('gridExplainCompact'),
        verbose: document.getElementById('gridExplainVerbose')
      };
      const setExplainView = (view) => {
        const activeView = explainPanels[view] ? view : 'brief';
        Object.entries(explainPanels).forEach(([key, panel]) => {
          if (!panel) return;
          panel.classList.toggle('hidden', key !== activeView);
        });
        explainButtons.forEach((btn) => {
          const isActive = btn.getAttribute('data-explain-view') === activeView;
          btn.classList.toggle('bg-white', isActive);
          btn.classList.toggle('text-slate-900', isActive);
          btn.classList.toggle('shadow-sm', isActive);
          btn.classList.toggle('text-slate-500', !isActive);
        });
      };
      if (explainButtons.length) {
        explainButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            setExplainView(btn.getAttribute('data-explain-view'));
          });
        });
      }
      setExplainView('brief');
      setupTabs();
      setupCarousel();
      updateGridSizeLabel();

      const spacingEl = document.getElementById('selGridSpacing');
      if (spacingEl) {
        spacingEl.addEventListener('change', updateGridSizeLabel);
      }

      const startEl = document.getElementById('inpStartPrice');
      if (startEl) {
        startEl.addEventListener('input', renderGridLadder);
        startEl.addEventListener('change', renderGridLadder);
      }

      const gridSizeEl = document.getElementById('inpGridSize');
      if (gridSizeEl) {
        gridSizeEl.addEventListener('input', renderGridLadder);
        gridSizeEl.addEventListener('change', renderGridLadder);
      }

      const tradeAmountEl = document.getElementById('inpTradeAmount');
      if (tradeAmountEl) {
        tradeAmountEl.addEventListener('input', renderGridLadder);
        tradeAmountEl.addEventListener('change', renderGridLadder);
      }
      const sharesEl = document.getElementById('inpShares');
      if (sharesEl) {
        sharesEl.addEventListener('input', renderGridLadder);
        sharesEl.addEventListener('change', renderGridLadder);
      }

      const levelEl = document.getElementById('inpLevelCount');
      if (levelEl) {
        levelEl.addEventListener('input', renderGridLadder);
        levelEl.addEventListener('change', renderGridLadder);
      }

      const levelUpEl = document.getElementById('inpLevelCountUp');
      if (levelUpEl) {
        levelUpEl.addEventListener('input', renderGridLadder);
        levelUpEl.addEventListener('change', renderGridLadder);
      }

      const tickSizeEl = document.getElementById('selTickSize');
      if (tickSizeEl) {
        tickSizeEl.addEventListener('change', renderGridLadder);
      }

      const copyBtn = document.getElementById('btnCopyGridJson');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          if (!LAST_GRID_JSON) return;
          const labelSpan = copyBtn.querySelector('[data-copy-label]');
          const original = labelSpan?.textContent || 'Copy JSON';
          if (labelSpan) labelSpan.textContent = 'Copying';
          copyBtn.classList.add('ring-1', 'ring-emerald-400/60');
          const success = await copyGridJsonToClipboard(LAST_GRID_JSON);
          if (success) {
            if (labelSpan) labelSpan.textContent = 'Copied!';
            copyBtn.classList.add('bg-emerald-600');
            setTimeout(() => {
              copyBtn.classList.remove('bg-emerald-600', 'ring-emerald-400/60', 'ring-1');
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          } else {
            copyBtn.classList.remove('ring-emerald-400/60', 'ring-1');
            if (labelSpan) labelSpan.textContent = 'Copy failed';
            setTimeout(() => {
              if (labelSpan) labelSpan.textContent = original;
            }, 1600);
          }
        });
      }

      const breakevenForm = document.getElementById('breakevenMatrixForm');
      if (breakevenForm) {
        breakevenForm.addEventListener('submit', (event) => {
          event.preventDefault();
          generateBreakevenMatrix();
        });
      }

      const breakevenResetBtn = document.getElementById('btnResetBreakeven');
      if (breakevenResetBtn) {
        breakevenResetBtn.addEventListener('click', (event) => {
          event.preventDefault();
          resetBreakevenInputs();
        });
      }

      renderGridLadder();
      generateBreakevenMatrix();
    });
  })();
</script>
</body>
</html>
